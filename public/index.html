<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFD700">
    <title>RECARGAS DHARCK STORE</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="/image/logo1.png" type="image/png">
    
    <!-- Version Control -->
    <script src="/version.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RB1V3F1WL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RB1V3F1WL');
</script>

</head>
<body>

    <style>
        .fixed-support-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .fixed-support-button button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #00a884;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .fixed-support-button button:hover {
            background-color: #008f72;
            transform: scale(1.05);
        }
        
        .fixed-support-button .support-icon {
            width: 24px;
            height: 24px;
            fill: white;
            margin-right: 8px;
        }
    </style>

    <!-- Header para el título de la aplicación -->
    <header class="app-header">
        <div class="dharck-store-title-container">
            <h1 class="dharck-store-title">
                DHARCK STORE
            </h1>
            <!-- La ruta /logo.png asume que 'logo.png' está directamente en la carpeta 'public/' en tu proyecto de Vercel. -->
            <img src="/image/logo.png" alt="Logotipo de la TIENDA DHARCK" class="title-logo">    
        </div>
        <!-- BOTÓN DE SOPORTE TÉCNICO MEJORADO -->

    </header>

    <!-- Barra de progreso -->
    <div class="progress-container">
        <div class="progress-bar" id="formProgress"></div>
    </div>

    <!-- Contenedor principal del formulario -->
    <div class="form-container">
        <form id="topupForm">
            <!-- PASO 1: Selección de país -->
            <div class="form-step active" id="step1">
                <div class="step-title">
                    <h2 data-step="1">Selecciona tu país</h2>
                </div>
                <div class="section-container" id="countrySelectionSection">
                    <div class="form-group">
                        <div id="countryButtonsContainer">
                            <!-- Los botones de país se generarán aquí con JS -->
                        </div>
                    </div>
                </div>
                <div class="step-navigation">
                    <button type="button" class="next-step" id="toStep2" disabled>Siguiente</button>
                </div>
            </div>

            <!-- PASO 2: Selección de juego -->
            <div class="form-step" id="step2">
                <div class="step-title">
                    <h2 data-step="2">Selecciona el juego</h2>
                </div>
                <div class="section-container" id="gameSelectionSection">
                    <div class="form-group">
                        <div id="gameButtonsContainer">
                            <!-- Los botones de juego se generarán aquí con JS -->
                        </div>
                    </div>
                </div>
                <div class="step-navigation">
                    <button type="button" class="next-step" id="toStep3" disabled>Siguiente</button>
                </div>
            </div>

            <!-- PASO 3: Selección de artículo -->
            <div class="form-step" id="step3">
                <div class="step-title">
                    <h2 data-step="3">Selecciona el artículo</h2>
                </div>
                <div id="amountSelection" class="form-group">
                    <div id="amountButtons">
                        <!-- Los divs de los artículos se generarán aquí con JS -->
                    </div>
                </div>
                <div class="step-navigation">
                    <button type="button" class="prev-step" id="backToStep2">Anterior</button>
                    <button type="button" class="next-step" id="toStep4" disabled>Siguiente</button>
                </div>
            </div>

            <!-- PASO 4: Información del jugador -->
            <div class="form-step" id="step4">
                <div class="step-title">
                    <h2 data-step="4">Información del jugador</h2>
                </div>
                <div id="userInfoSection">
                    <!-- ID y Nombre (Para Lords Mobile, Free Fire, Mobile Legends) -->
                    <div id="idNameInputs" style="display: none;">
                        <div class="form-group">
                            <label for="userId">
                                ID DEL JUGADOR:
                            </label>
                            <input
                                type="tel"
                                id="userId"
                                name="userId"
                                placeholder="Ej: 1234567890"
                                pattern="[0-9]*"
                                title="Por favor, ingresa solo números."
                            />
                        </div>
                        <div class="form-group">
                            <label for="userName">
                                NOMBRE DEL JUGADOR:
                            </label>
                            <input
                                type="text"
                                id="userName"
                                name="userName"
                                placeholder="Ej: ElCojeViejas300"
                            />
                        </div>
                    </div>

                    <!-- ID y Servidor (Para Genshin Impact, Mobile Legends) -->
                    <div id="idServerInputs" style="display: none;">
                        <div class="form-group">
                            <label for="userIdServer">
                                ID DEL JUGADOR (UID):
                            </label>
                            <input
                                type="tel"
                                id="userIdServer"
                                name="userIdServer"
                                placeholder="Ej: 123456789 (UID)"
                                pattern="[0-9]*"
                                title="Por favor, ingresa solo números para el UID."
                            />
                        </div>
                        <div class="form-group">
                            <label for="serverInput">
                                SERVIDOR:
                            </label>
                            <input
                                type="text"
                                id="serverInput"
                                name="serverInput"
                                placeholder="Ej: América, Asia, Europa"
                            />
                        </div>
                        <!-- Nombre del jugador para Mobile Legends, si aplica en este grupo -->
                        <div class="form-group" id="mlNameInput" style="display: none;">
                            <label for="userNameML">
                                NOMBRE DEL JUGADOR:
                            </label>
                            <input
                                type="text"
                                id="userNameML"
                                name="userNameML"
                                placeholder="Ej: MiNombreDeML"
                            />
                        </div>
                    </div>

                    <!-- ID Solamente (Para Blood Strike, PUBG Mobile, Delta Force) -->
                    <div id="idOnlyInputs" style="display: none;">
                        <div class="form-group">
                            <label for="userIdOnly">
                                ID DEL JUGADOR:
                            </label>
                            <input
                                type="tel"
                                id="userIdOnly"
                                name="userIdOnly"
                                placeholder="Ej: 1234567890"
                                pattern="[0-9]*"
                                title="Por favor, ingresa solo números."
                            />
                        </div>
                    </div>

                    <!-- Campos completos para Call of Duty Mobile -->
                    <div id="codInputs" style="display: none;">
                        <div class="form-group">
                            <label for="emailInput">
                                CORREO ELECTRÓNICO:
                            </label>
                            <input
                                type="email"
                                id="emailInput"
                                name="emailInput"
                                placeholder="Ej: tu_correo@example.com"
                            />
                        </div>
                        <div class="form-group">
                            <label for="passwordInput">
                                CONTRASEÑA:
                            </label>
                            <input
                                type="password"
                                id="passwordInput"
                                name="passwordInput"
                                placeholder="Ingresa tu contraseña"
                            />
                        </div>
                        <div class="form-group">
                            <label for="linkageInput">
                                VINCULACIÓN (Gmail, Facebook, Activision):
                            </label>
                            <input
                                type="text"
                                id="linkageInput"
                                name="linkageInput"
                                placeholder="Ej: Gmail"
                            />
                        </div>
                        <div class="form-group">
                            <label for="exactAccountNameInput">
                                NOMBRE EXACTO DE LA CUENTA:
                            </label>
                            <input
                                type="text"
                                id="exactAccountNameInput"
                                name="exactAccountNameInput"
                                placeholder="Ej: TuNombreExactoEnCOD"
                            />
                        </div>
                    </div>
                </div>
                <div class="step-navigation">
                    <button type="button" class="next-step" id="toStep5">Siguiente</button>
                </div>
            </div>

            <!-- PASO 5: Selección de vendedor -->
            <div class="form-step" id="step5">
                <div class="step-title">
                    <h2 data-step="5">Selecciona tu vendedor favorito</h2>
                </div>
                <div class="form-group">
                    <div id="sellerButtonsContainer">
                        <!-- Los botones de vendedor se generarán aquí con JS -->
                    </div>
                </div>
                <div class="step-navigation">
                    <button type="button" class="next-step" id="toStep6" disabled>Siguiente</button>
                </div>
            </div>

            <!-- PASO 6: Resumen de pedido y Métodos de pago (combinados) -->
            <div class="form-step" id="step6">
                <div class="step-title">
                    <h2 data-step="6">Resumen y Métodos de pago</h2>
                </div>
                <div id="priceSummary">
                    <div id="selectedItemsPreview">
                        <!-- Las miniaturas de los artículos seleccionados se mostrarán aquí -->
                    </div>
                    <p>
                        TOTAL A PAGAR: <span id="totalPriceDisplay"></span> <span id="currencySymbolDisplay"></span>
                    </p>
                    <p>
                        (BASADO EN <span id="baseAmountDisplay"></span> USD + COMISION!)
                    </p>
                </div>
                
                <div id="paymentMethodsDisplay">
                    <div id="paymentMethodsList"></div>
                </div>

                <!-- Mensaje de advertencia actualizado -->
                <div id="transferWarningMessage" class="transfer-warning">
                    ¡Importante! Asegúrate de haber realizado el pago antes de enviar el pedido. La entrega puede demorar entre 5 a 15 minutos en reflejarse en el juego.
                </div>

                <!-- Solo un botón de envío -->
                <button
                    type="submit"
                    id="sendWhatsAppOrderBtn"
                    class="action-button"
                >
                    ENVIAR PEDIDO
                </button>

                <div id="messageDisplay" style="display: none;"></div>
            </div>

            <!-- Campos ocultos para el formulario -->
            <input type="hidden" id="gameHidden" name="game">
            <input type="hidden" id="amountUSDHidden" name="amountUSD">
            <input type="hidden" id="totalPriceHidden" name="totalPrice">
            <input type="hidden" id="currencySymbolHidden" name="currencySymbol">
        </form>
    </div>

    <div id="whatsappWarningModal" style="position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none;">
        <div style="background-color: rgba(10, 0, 30, 0.95); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 100%; text-align: center;">
            <h2>¡Importante!</h2>
            <p style="color: #e0f2fe;">
                Tu pedido será enviado por WhatsApp.
                <span style="color: #ff00ff;">Recuerda realizar el pago usando los métodos mostrados y enviar el comprobante por WhatsApp.</span>
            </p>
            <div>
                <button id="cancelWhatsApp" type="button">
                    Cancelar
                </button>
                <button id="confirmWhatsApp" type="button">
                    Confirmar y Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (NUEVO) -->
    <div id="loadingOverlay" style="position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 1001; color: white; display: none;">
        <div class="spinner" style="border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #00ffff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px; font-size: 1.2em; color: #00ffff; text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);" class="loading-text">Cargando...</p>
    </div>

    <script type="module">

        // Número de WhatsApp Business predeterminado (fallback si no se encuentra el vendedor)
        const DEFAULT_WHATSAPP_NUMBER = '584126027407'; 

        // Configuración de ganancias por artículo (SOLO PARA ADMINISTRADORES - NO VISIBLE AL PÚBLICO)
        const SELLER_PROFIT_CONFIG = {
            'FREE FIRE': 0.40,
            'DELTA FORCE STEAM': 0.60, 
            'DELTA FORCE GARENA': 0.60,
            'CALL OF DUTY MOBILE': 0.70,
            'PUBG MOBILE': 0.50,
            'MOBILE LEGENDS': 0.45,
            'DEFAULT': 0.50
        };

        // Elementos ocultos (ahora solo para datos del formulario)
        const gameHidden = document.getElementById('gameHidden');
        const amountUSDHidden = document.getElementById('amountUSDHidden');
        const totalPriceHidden = document.getElementById('totalPriceHidden');
        const currencySymbolHidden = document.getElementById('currencySymbolHidden');


        // Referencias al modal
        const whatsappWarningModal = document.getElementById('whatsappWarningModal');
        const confirmWhatsAppBtn = document.getElementById('confirmWhatsApp');
        const cancelWhatsAppBtn = document.getElementById('cancelWhatsApp');

        // Botón de acción
        const sendWhatsAppOrderBtn = document.getElementById('sendWhatsAppOrderBtn');
        const loadingOverlay = document.getElementById('loadingOverlay'); // Referencia al overlay de carga

        // Elementos del DOM para campos dinámicos
        const countrySelectionSection = document.getElementById('countrySelectionSection'); // Nueva sección para país
        const gameSelectionSection = document.getElementById('gameSelectionSection');
        const amountSelectionDiv = document.getElementById('amountSelection');
        const userInfoSection = document.getElementById('userInfoSection'); // Nuevo contenedor para todos los campos de usuario
        const idNameInputs = document.getElementById('idNameInputs');
        const userIdInput = document.getElementById('userId'); 
        const userNameInput = document.getElementById('userName'); 

        const idServerInputs = document.getElementById('idServerInputs');
        const userIdServerInput = document.getElementById('userIdServer');
        const serverInput = document.getElementById('serverInput');
        const userNameMLInput = document.getElementById('userNameML'); 

        const idOnlyInputs = document.getElementById('idOnlyInputs');
        const userIdOnlyInput = document.getElementById('userIdOnly');

        const codInputs = document.getElementById('codInputs');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const linkageInput = document.getElementById('linkageInput');
        const exactAccountNameInput = document.getElementById('exactAccountNameInput');

        // ========== SISTEMA DE PROMOCIONES DINÁMICAS ==========
        // Sistema de promociones dinámicas (fácil activar/desactivar)
        const ACTIVE_PROMOTIONS = {
            // Activar/desactivar promociones cambiando true/false
            'LORDS_MOBILE_PROMO': true,      // Promoción Lords Mobile
            'FREE_FIRE_WEEKEND': true,       // Promoción Free Fire
            'BLOOD_STRIKE_BONUS': false,     // Promoción Blood Strike
            'GENSHIN_SPECIAL': false,        // Promoción Genshin Impact
            'PUBG_MOBILE_PROMO': false,      // Promoción PUBG Mobile
            'DELTA_FORCE_STEAM_PROMO': false, // Promoción Delta Force Steam
            'DELTA_FORCE_GARENA_PROMO': false, // Promoción Delta Force Garena
            'COD_MOBILE_PROMO': false,       // Promoción Call of Duty Mobile
            'MOBILE_LEGENDS_PROMO': false    // Promoción Mobile Legends
        };

        // Configuración de promociones por juego
        const PROMOTION_CONFIG = {
            'LORDS MOBILE': {
                active: ACTIVE_PROMOTIONS.LORDS_MOBILE_PROMO,
                type: '+25%',
                badge: '🔥Cupón aleatorio 20%-25%-30%',
                animation: 'promo-pulse',
                articles: [
                    '💎499+CUPON',
                    '💎999+CUPON',
                    '💎1999+CUPON',
                    '💎2499+CUPON',
                    '💎2999+CUPON',
                    '💎4999+CUPON',
                    '💎9999+CUPON'
                ]
            },
            'FREE FIRE': {
                active: ACTIVE_PROMOTIONS.FREE_FIRE_WEEKEND,
                type: '+20%',
                badge: '🔥Promo Fin de Semana',
                animation: 'promo-glow',
                articles: [
                    '💎SEMANAL',
                    '💎MENSUAL',
                    '💎100+10',
                    '💎200+20',
                    '💎310+31'
                ]
            },
            'BLOOD STRIKE': {
                active: ACTIVE_PROMOTIONS.BLOOD_STRIKE_BONUS,
                type: '+15%',
                badge: '🔥Bonus Especial',
                animation: 'promo-pulse',
                articles: [
                    'PASE ELITE',
                    'PASE PREMIUM',
                    '1000+100',
                    '2000+200'
                ]
            },
            'GENSHIN IMPACT': {
                active: ACTIVE_PROMOTIONS.GENSHIN_SPECIAL,
                type: '+30%',
                badge: '🔥Oferta Especial',
                animation: 'promo-glow',
                articles: [
                    'PASE LUNAR',
                    '300+30',
                    '980+110'
                ]
            },
            'PUBG MOBILE': {
                active: ACTIVE_PROMOTIONS.PUBG_MOBILE_PROMO,
                type: '+20%',
                badge: '🔥Promo PUBG',
                animation: 'promo-pulse',
                articles: [
                    '300+25',
                    '600+60',
                    '1500+300'
                ]
            },
            'DELTA FORCE STEAM': {
                active: ACTIVE_PROMOTIONS.DELTA_FORCE_STEAM_PROMO,
                type: '+25%',
                badge: '🔥Steam Especial',
                animation: 'promo-glow',
                articles: [
                    '300+20 Coins',
                    '420+40 Coins',
                    '680+70 Coins'
                ]
            },
            'DELTA FORCE GARENA': {
                active: ACTIVE_PROMOTIONS.DELTA_FORCE_GARENA_PROMO,
                type: '+25%',
                badge: '🔥Garena Especial',
                animation: 'promo-pulse',
                articles: [
                    '300+36 Coins',
                    '420+62 Coins',
                    '680+105 Coins'
                ]
            },
            'CALL OF DUTY MOBILE': {
                active: ACTIVE_PROMOTIONS.COD_MOBILE_PROMO,
                type: '+20%',
                badge: '🔥COD Promo',
                animation: 'promo-glow',
                articles: [
                    '420 CP',
                    '880 CP',
                    '2400 CP'
                ]
            },
            'MOBILE LEGENDS': {
                active: ACTIVE_PROMOTIONS.MOBILE_LEGENDS_PROMO,
                type: '+30%',
                badge: '🔥ML Especial',
                animation: 'promo-pulse',
                articles: [
                    'PASE SEMANAL ML',
                    'CREPUSCULAR',
                    '150+15💎',
                    '250+25💎',
                    '500+65💎'
                ]
            }
        };

        // Función para verificar si un artículo está en promoción
        function isArticleInPromotion(gameName, articleLabel) {
            const gamePromo = PROMOTION_CONFIG[gameName];
            return gamePromo && gamePromo.active && gamePromo.articles.includes(articleLabel);
        }

        // Función para obtener información de promoción
        function getPromotionInfo(gameName, articleLabel) {
            if (isArticleInPromotion(gameName, articleLabel)) {
                return PROMOTION_CONFIG[gameName];
            }
            return null;
        }

        // Función para activar/desactivar promociones (para uso administrativo)
        function togglePromotion(promotionKey, isActive) {
            if (ACTIVE_PROMOTIONS.hasOwnProperty(promotionKey)) {
                ACTIVE_PROMOTIONS[promotionKey] = isActive;
                console.log(`Promoción ${promotionKey} ${isActive ? 'activada' : 'desactivada'}`);
                
                // Actualizar la vista si hay un juego seleccionado
                if (selectedGame) {
                    updateAmountSelection();
                }
            } else {
                console.error(`Promoción ${promotionKey} no encontrada`);
            }
        }

        // Función para obtener el estado de todas las promociones
        function getPromotionStatus() {
            return { ...ACTIVE_PROMOTIONS };
        }

        // ========== FIN SISTEMA DE PROMOCIONES ==========

        // Datos de juegos y sus precios base en USD
        // Se añade 'logoUrl' para cada juego para los botones.
        // NOTA: Asegúrate de que todas las imágenes referenciadas aquí (logoUrl y imageUrl)
        // existan en tu carpeta 'public/image/' en Vercel y que estén optimizadas (comprimidas)
        // para una carga rápida de la página.
        let gameOptions = [
            {
                name: 'LORDS MOBILE',
                logoUrl: '/image/lm1.png',
                inputRequirement: 'id_name',
                amounts: [
//                    { label: '💎499+CUPON', value: 5.20, imageUrl: '/image/prize-2.png', promotion: false },
//                    { label: '💎999+CUPON', value: 12.00, imageUrl: '/image/prize-3.png', promotion: false },
//                    { label: '💎1999+CUPON', value: 20.00, imageUrl: '/image/prize-4.png', promotion: false },
//                    { label: '💎2499+CUPON', value: 25.50, imageUrl: '/image/prize-5.png', promotion: false },
//                    { label: '💎2999+CUPON', value: 30.00, imageUrl: '/image/prize-6.png', promotion: false },
//                    { label: '💎4999+CUPON', value: 48.50, imageUrl: '/image/prize-7.png', promotion: false },
//                    { label: '💎9999+CUPON', value: 95.00, imageUrl: '/image/icon-happy.png', promotion: false },
                    { label: 'PASE SEMANAL', value: 2.30, imageUrl: '/image/7day.png', promotion: false },
                    { label: 'PASE MENSUAL', value: 19.90, imageUrl: '/image/30day.png', promotion: false },
                    { label: '209💎', value: 2.30, imageUrl: '/image/prize-2.png', promotion: false },
                    { label: '524💎', value: 5.20, imageUrl: '/image/prize-3.png', promotion: false },
                    { label: '1048💎', value: 10.00, imageUrl: '/image/prize-4.png', promotion: false },
                    { label: '2096💎', value: 19.50, imageUrl: '/image/prize-5.png', promotion: false },
                    { label: '3144💎', value: 29.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '5240💎', value: 48.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '6812💎', value: 62.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '9956💎', value: 92.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '19912💎', value: 178.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '30392💎', value: 270.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '50304💎', value: 440.00, imageUrl: '/image/icon-happy.png', promotion: false }
                ]
            },
            {
                name: 'BLOOD STRIKE',
                logoUrl: '/image/bs.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '100+5', value: 0.89, imageUrl: '/image/100.png', promotion: false },
                    { label: '300+20', value: 2.50, imageUrl: '/image/300.png', promotion: false },
                    { label: '500+40', value: 4.30, imageUrl: '/image/500.png', promotion: false },
                    { label: '1000+100', value: 8.50, imageUrl: '/image/1000.png', promotion: false },
                    { label: '2000+200', value: 17.60, imageUrl: '/image/2000.png', promotion: false },
                    { label: '5000+800', value: 42.00, imageUrl: '/image/5000.png', promotion: false },
                    { label: 'PASE ELITE', value: 3.50, imageUrl: '/image/elite.png', promotion: false },
                    { label: 'PASE PREMIUM', value: 8.51, imageUrl: '/image/premium.png', promotion: false },
                    { label: 'PASE DE NIVEL', value: 2.00, imageUrl: '/image/mejora.png', promotion: false }
                ]
            },
            {
                name: 'FREE FIRE',
                logoUrl: '/image/ff1.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '💎SEMANAL', value: 1.80, imageUrl: '/image/ffs.png', promotion: false },
                    { label: '💎MENSUAL', value: 9.50, imageUrl: '/image/ffm.png', promotion: false },
                    { label: '💎100+10', value: 0.99, imageUrl: '/image/prize-2.png', promotion: false },
                    { label: '💎200+20', value: 1.90, imageUrl: '/image/prize-3.png', promotion: false },
                    { label: '💎310+31', value: 2.80, imageUrl: '/image/prize-4.png', promotion: false },
                    { label: '💎520+52', value: 4.60, imageUrl: '/image/prize-5.png', promotion: false },
                    { label: '💎1069+106', value: 9.50, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '💎2180+218', value: 18.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '💎5600+560', value: 40.00, imageUrl: '/image/prize-7.png', promotion: false }
                ]
            },
            {
                name: 'GENSHIN IMPACT',
                logoUrl: '/image/gi.png',
                inputRequirement: 'id_server',
                amounts: [
                    { label: 'PASE LUNAR', value: 4.8, imageUrl: '/image/bl.png', promotion: false },
                    { label: '60', value: 0.90, imageUrl: '/image/cg1.png', promotion: false },
                    { label: '300+30', value: 4.70, imageUrl: '/image/cg2.png', promotion: false },
                    { label: '980+110', value: 13.00, imageUrl: '/image/cg3.png', promotion: false },
                    { label: '1980+260', value: 27.00, imageUrl: '/image/cg4.png', promotion: false },
                    { label: '3280+600', value: 45.50, imageUrl: '/image/cg5.png', promotion: false },
                    { label: '6480+1600', value: 90.00, imageUrl: '/image/cg6.png', promotion: false }
                ]
            },
            {
                name: 'PUBG MOBILE',
                logoUrl: '/image/pm1.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60', value: 0.99, imageUrl: '/image/pm.png', promotion: false },
                    { label: '300+25', value: 4.85, imageUrl: '/image/pm.png', promotion: false },
                    { label: '600+60', value: 9.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '1500+300', value: 23.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '3000+850', value: 45.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '6000+2100', value: 92.00, imageUrl: '/image/pm.png', promotion: false }
                ]
            },
            {
                name: 'DELTA FORCE STEAM',
                logoUrl: '/image/dfss.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60 Coins', value: 0.99, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '300+20 Coins', value: 4.70, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '420+40 Coins', value: 6.80, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '680+70 Coins', value: 9.00, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '1280+200 Coins', value: 17.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '1680+300 Coins', value: 21.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '3280+670 Coins', value: 40.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '6480+1620 Coins', value: 80.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '12960+3240 Coins', value: 174.00, imageUrl: '/image/dfs5.png', promotion: false },
                    { label: '19440+4860 Coins', value: 260.00, imageUrl: '/image/dfs5.png', promotion: false }
                ]
            },
            {
                name: 'DELTA FORCE GARENA',
                logoUrl: '/image/dfsg.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60 Coins', value: 0.99, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '300+36 Coins', value: 4.80, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '420+62 Coins', value: 7.00, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '680+105 Coins', value: 9.60, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '1280+264 Coins', value: 19.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '1680+385 Coins', value: 23.50, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '3280+834 Coins', value: 45.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '6480+1944 Coins', value: 88.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '12960+3888 Coins', value: 180.00, imageUrl: '/image/dfs5.png', promotion: false },
                    { label: '19440+5832 Coins', value: 270.00, imageUrl: '/image/dfs5.png', promotion: false }
                ]
            },
            {
                name: 'CALL OF DUTY MOBILE',
                logoUrl: '/image/codm.png',
                inputRequirement: 'cod_full',
                amounts: [
                    { label: '80 CP', value: 1.50, imageUrl: '/image/cm1.png', promotion: false },
                    { label: '420 CP', value: 5.50, imageUrl: '/image/cm1.png', promotion: false },
                    { label: '880 CP', value: 11.00, imageUrl: '/image/cm2.png', promotion: false },
                    { label: '2400 CP', value: 26.00, imageUrl: '/image/cm2.png', promotion: false },
                    { label: '5000 CP', value: 55.00, imageUrl: '/image/cm4.png', promotion: false },
                    { label: '10800 CP', value: 110.00, imageUrl: '/image/cm4.png', promotion: false }
                ]
            },
            {
                name: 'MOBILE LEGENDS',
                logoUrl: '/image/ml.png',
                inputRequirement: 'id_server_name',
                amounts: [
                    { label: 'PASE SEMANAL ML', value: 1.60, imageUrl: '/image/ml7.png', promotion: false },
                    { label: 'CREPUSCULAR', value: 9.50, imageUrl: '/image/ml7.png', promotion: false },
                    { label: '50+5💎', value: 0.90, imageUrl: '/image/ml1.png', promotion: false },
                    { label: '150+15💎', value: 2.80, imageUrl: '/image/ml1.png', promotion: false },
                    { label: '250+25💎', value: 4.40, imageUrl: '/image/ml2.png', promotion: false },
                    { label: '500+65💎', value: 8.30, imageUrl: '/image/ml2.png', promotion: false },
                    { label: '625+81💎', value: 10.00, imageUrl: '/image/ml3.png', promotion: false },
                    { label: '940+144💎', value: 18.00, imageUrl: '/image/ml3.png', promotion: false },
                    { label: '1860+335💎', value: 27.50, imageUrl: '/image/ml4.png', promotion: false },
                    { label: '3099+589💎', value: 44.20, imageUrl: '/image/ml4.png', promotion: false },
                    { label: '4649+883💎', value: 65.40, imageUrl: '/image/ml5.png', promotion: false },
                    { label: '7740+1548💎', value: 110.00, imageUrl: '/image/ml6.png', promotion: false }
                ]
            }
        ];

        // Datos de países y tasas de cambio - AHORA SE CARGAN DINÁMICAMENTE
        let countryData = [
            // Datos por defecto que se actualizarán desde la API
            {
                name: 'VENEZUELA',
                code: 'VES',
                exchangeRate: 144.5,
                symbol: 'Bs.',
                imageUrl: '/image/paises/ve.png',
                paymentMethods: [
                    { name: 'Pago Móvil', details: 'C.I.: V-32147818, Teléfono: 04126027407, Banco: 0105 (Banco Mercantil)' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'COLOMBIA',
                code: 'COP',
                exchangeRate: 4150,
                symbol: 'COP',
                imageUrl: '/image/paises/co.png',
                paymentMethods: [
                    { name: 'Nequi', details: 'Número: 3012660676 Nombre:Ali.' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'PERU',
                code: 'PEN',
                exchangeRate: 3.85,
                symbol: 'S/.',
                imageUrl: '/image/paises/pe.png',
                paymentMethods: [
                    { name: 'BCP', details: 'Cuenta: 38097062947042, Titular: Yoshimara' },
                    { name: 'Yape', details: 'Número: 974610375' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'MEXICO',
                code: 'MXN',
                exchangeRate: 20,
                symbol: 'MXN',
                imageUrl: '/image/paises/mx.png',
                paymentMethods: [
                    { name: 'SPIN BY OXXO', details: 'TARJETA: 4217 4701 8364 0099' },
                    { name: 'BANCO AZTECA', details: 'INTERBANCARIA: 1277 9700 1467 5859 00' },
                    { name: 'Titular', details: 'Jesus Carrillo' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ESTADOS UNIDOS',
                code: 'USD',
                exchangeRate: 1.05,
                symbol: '$',
                imageUrl: '/image/paises/us.png',
                paymentMethods: [
                    { name: 'Zelle', details: '+1 (661) 736 - 0564, Nombre: Jannett Martinez Lopez' },
                    { name: 'Titular', details: 'Jannett Martinez Lopez' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ARGENTINA',
                code: 'ARS',
                exchangeRate: 1320,
                symbol: '$',
                imageUrl: '/image/paises/ar.png',
                paymentMethods: [
                    { name: 'Mercado pago', details: '0000003100069089540216' },
                    { name: 'UALA', details: '3840200500000000199867' },
                    { name: 'Titular', details: 'Pamela Schneider' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ECUADOR',
                code: 'USD',
                exchangeRate: 1.06,
                symbol: '$',
                imageUrl: '/image/paises/ec.png',
                paymentMethods: [
                    { name: 'Banco Pichincha', details: 'Cta. ahorros 2204277346' },
                    { name: 'Banco de Guayaquil', details: 'Cta. ahorros 0039924590' },
                    { name: 'Titular', details: 'María de los Ángeles Ronquillo León. CI: 0941414203' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'CHILE',
                code: 'CLP',
                exchangeRate: 1010,
                symbol: '$',
                imageUrl: '/image/paises/cl.png',
                paymentMethods: [
                    { name: 'BANCO FALABELLA', details: 'RUT: 17244216-1 / gi553ll30@gmail.com / Cta Corriente: 1-983-036407-8' },
                    { name: 'BANCO ESTADO', details: 'RUT: 17244216-1 / Cta Corriente: 37100135052 / 300 PESOS EXTRAS AL VALOR TOTAL'},
                    { name: 'Titular', details: 'GISSELLE GONZALEZ'},
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!'},
                ]
            },
            {
                name: 'ESPAÑA',
                code: 'EUR',
                exchangeRate: 1.04,
                symbol: '€',
                imageUrl: '/image/paises/es.png',
                paymentMethods: [
                    { name: 'BIZUM', details: '612237372 / 614153840 / CUALQUIERA DE LOS DOS' },
                    { name: 'BANCO SANTANDER', details: 'Cuenta bancaria : ES0800495939582916425258' },
                    { name: 'Titular', details: 'MAX FRANCIS SILVA RAMOS' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'COSTA RICA',
                code: 'CRC',
                exchangeRate: 600,
                symbol: '₡',
                imageUrl: '/image/paises/cr.png',
                paymentMethods: [
                    { name: 'SIMPE', details: '63223852' },
                    { name: 'Titular', details: 'Solange Granja Duarte' },
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'BOLIVIA',
                code: 'BOB',
                exchangeRate: 15.5,
                symbol: 'Bs.',
                imageUrl: '/image/paises/bo.png',
                paymentMethods: [
                    { name: 'Banco ganadero', details: '1311307078' }, 
                    { name: 'Tigo Money', details: '69172559' }, 
                    { name: 'Titular', details: 'Brandon Salazar Gutiérrez'}, 
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'NICARAGUA',
                code: 'NIO',
                exchangeRate: 43.5,
                symbol: 'C$',
                imageUrl: '/image/paises/ni.png',
                paymentMethods: [
                    { name: 'BAC CÓRDOBAS', details: 'Email: Nomiflores72@gmail.com' }, 
                    { name: 'Cta. ahorros:', details: '363278672' }, 
                    { name: 'Titular', details: 'Nahomi Flores Velásquez'}, 
                    { name: '¡IMPORTANTE!', details: '¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
        ];


        // === OPTIMIZACIONES DE RENDIMIENTO ===
        
        // Throttle function para limitar la frecuencia de ejecución
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Debounce function para retrasar la ejecución
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Lazy loading para imágenes
        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                img.classList.remove('lazy');
                                observer.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '50px 0px',
                    threshold: 0.01
                });

                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Fallback para navegadores sin IntersectionObserver
                document.querySelectorAll('img[data-src]').forEach(img => {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                });
            }
        }

        // Optimizar carga de imágenes
        function optimizeImages() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                // Añadir loading lazy nativo
                img.loading = 'lazy';
                
                // Optimizar tamaño de imagen según el dispositivo
                if (window.innerWidth <= 768) {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                }
                
                // Manejar errores de carga
                img.onerror = function() {
                    this.style.display = 'none';
                    console.warn('Error cargando imagen:', this.src);
                };
            });
        }

        // Gestión optimizada de intervalos
        let intervals = {
            exchangeRates: null,
            articlesConfig: null,
            serviceWorker: null
        };

        function clearAllIntervals() {
            Object.values(intervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
        }

        // Función para cargar tasas de cambio actualizadas desde la API
        async function loadExchangeRates() {
            try {
                const BASE_API_URL = window.location.origin;
                const response = await fetch(`${BASE_API_URL}/api/get-exchange-rates`);
                if (response.ok) {
                    const updatedRates = await response.json();
                    
                    // Actualizar las tasas de cambio manteniendo los demás datos
                    countryData = countryData.map(country => {
                        const updatedCountry = updatedRates.find(rate => rate.name === country.name);
                        if (updatedCountry) {
                            return {
                                ...country,
                                exchangeRate: updatedCountry.exchangeRate
                            };
                        }
                        return country;
                    });
                    
                    console.log('Tasas de cambio actualizadas exitosamente');
                    
                    // Actualizar la interfaz si hay un país seleccionado
                    if (selectedCountry) {
                        updatePriceDisplay();
                    }
                } else {
                    console.log('No se pudieron cargar las tasas actualizadas, usando valores por defecto');
                }
            } catch (error) {
                console.log('Error al cargar tasas de cambio:', error);
                console.log('Usando tasas de cambio por defecto');
            }
        }

        // Optimizar carga de tasas de cambio
        const optimizedLoadExchangeRates = throttle(async function() {
            try {
                const response = await fetch('/api/exchange-rates');
                if (response.ok) {
                    const rates = await response.json();
                    
                    // Actualizar solo si hay cambios
                    const currentRates = JSON.stringify(countryData.map(c => ({name: c.name, rate: c.exchangeRate})));
                    const newRates = JSON.stringify(rates.map(r => ({name: r.name, rate: r.exchangeRate})));
                    
                    if (currentRates !== newRates) {
                        countryData = countryData.map(country => {
                            const updatedCountry = rates.find(rate => rate.name === country.name);
                            if (updatedCountry) {
                                return {
                                    ...country,
                                    exchangeRate: updatedCountry.exchangeRate
                                };
                            }
                            return country;
                        });
                        updatePriceDisplay();
                    }
                }
            } catch (error) {
                console.warn('Error cargando tasas de cambio:', error);
            }
        }, 30000); // Máximo una vez cada 30 segundos

        // Función para actualizar la visualización de precios
        function updatePriceDisplay() {
            if (selectedAmount && selectedCountry) {
                const countryInfo = countryData.find(c => c.name === selectedCountry) || defaultCountryInfo;
                totalPrice = selectedAmount.value * countryInfo.exchangeRate;
                currencySymbol = countryInfo.symbol;
                
                totalPriceDisplay.textContent = formatNumber(totalPrice);
                currencySymbolDisplay.textContent = currencySymbol;
                baseAmountDisplay.textContent = selectedAmount.value.toFixed(2);
            }
        }

        // Datos de vendedores (RUTAS DE IMAGEN Y RECOMENDACIÓN DE TAMAÑO ACTUALIZADAS)
        // RECOMENDACIÓN DE TAMAÑO DE IMAGEN PARA VENDEDORES: Se recomienda usar imágenes cuadradas (ej. 60x60px o 80x80px)
        // para los logos/fotos de los vendedores. Esto asegura que se vean bien en los botones circulares.
        // Asegúrate de que los nombres de archivo coincidan con los nombres aquí (e.g., 'xjosdharckx.png').
        const sellerData = [
            { name: 'XJoseDharckX', phoneNumber: '584126027407', imageUrl: '/image/vendedores/xjosedharckx.png' }, // Ruta actualizada
            { name: 'Miguel', phoneNumber: '5214951219766', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'Alfredo Favier', phoneNumber: '5353148505', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'Candy Candy', phoneNumber: '584144274483', imageUrl: '/image/vendedores/david.png' }, // Ruta actualizada
            { name: 'Satoru', phoneNumber: '5491170897494', imageUrl: '/image/vendedores/satoru.png' }, // Ruta actualizada
            { name: 'Ernesto', phoneNumber: '573025129990', imageUrl: '/image/vendedores/ernesto.png' }, // Ruta actualizada
            { name: 'OSCAR', phoneNumber: '573002030533', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'SpartanoWolf98', phoneNumber: '584262276868', imageUrl: '/image/vendedores/SpartanoWolf98.png' }, // Nuevo vendedor agregado
            { name: 'Jhack', phoneNumber: '584247582765', imageUrl: '/image/vendedores/Jhack.png' }, // Nuevo vendedor
            { name: 'Enmanuel', phoneNumber: '50586521013', imageUrl: '/image/vendedores/Enmanuel.png' }, // NUEVO VENDEDOR
            { name: 'Mateo', phoneNumber: '573116318052', imageUrl: '/image/vendedores/Mateo.png' }, // NUEVO VENDEDOR AGREGADO
            // Puedes añadir más vendedores aquí si es necesario
        ];

        let selectedGame = '';
        let selectedAmount = null; // Un solo artículo seleccionado (objeto)
        let selectedCountry = ''; 
        let selectedSeller = ''; 
        let totalPrice = 0;
        let currencySymbol = 'USD';
        // Se asegura que defaultCountryInfo exista, usando un valor por defecto si no se encuentra 'USD'
        let defaultCountryInfo = countryData.find(c => c.code === 'USD') || { name: 'ESTADOS UNIDOS', code: 'USD', exchangeRate: 1.00, symbol: '$', paymentMethods: [], imageUrl: '/image/paises/US.png' };


        const countrySelectContainer = document.getElementById('countryButtonsContainer'); 
        const gameButtonsContainer = document.getElementById('gameButtonsContainer');
        const amountButtonsDiv = document.getElementById('amountButtons');
        const sellerSelectContainer = document.getElementById('sellerButtonsContainer'); 
        const priceSummaryDiv = document.getElementById('priceSummary');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const currencySymbolDisplay = document.getElementById('currencySymbolDisplay');
        const baseAmountDisplay = document.getElementById('baseAmountDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const topupForm = document.getElementById('topupForm');
        const paymentMethodsDisplayDiv = document.getElementById('paymentMethodsDisplay');
        const paymentMethodsListDiv = document.getElementById('paymentMethodsList');
        const transferWarningMessage = document.getElementById('transferWarningMessage');
        const selectedItemsPreview = document.getElementById('selectedItemsPreview'); // Contenedor para miniaturas


        // Función para formatear números con separadores de miles y decimales (puntos y comas)
        function formatNumber(num) {
            // Convierte el número a una cadena con 2 decimales
            let formattedNum = num.toFixed(2);
            // Separa la parte entera de la parte decimal
            let parts = formattedNum.split('.');
            // Formatea la parte entera con puntos como separador de miles
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            // Junta las partes con coma como separador decimal
            return parts.join(',');
        }

        // Función para validar todos los campos y habilitar/deshabilitar el botón de Enviar Pedido
        function updateSendOrderButtonState() {
            const gameSelected = selectedGame !== '';
            const amountSelected = selectedAmount !== null;
            const countrySelected = selectedCountry !== '';
            const sellerSelected = selectedSeller !== '';
            
            // Validar comprobante de pago - ya no es necesario
            let paymentProofSelected = true; // Siempre true ya que no requerimos comprobante
            
            // Validar campos específicos del juego
            let userInfoValid = false;
            if (idNameInputs.style.display === 'block') {
                userInfoValid = userIdInput.value.trim() !== '' && userNameInput.value.trim() !== '';
            } else if (idServerInputs.style.display === 'block') {
                const mlNameValid = document.getElementById('mlNameInput').style.display === 'block' ? 
                    userNameMLInput.value.trim() !== '' : true;
                userInfoValid = userIdServerInput.value.trim() !== '' && serverInput.value.trim() !== '' && mlNameValid;
            } else if (idOnlyInputs.style.display === 'block') {
                userInfoValid = userIdOnlyInput.value.trim() !== '';
            } else if (codInputs.style.display === 'block') {
                userInfoValid = emailInput.value.trim() !== '' && 
                               passwordInput.value.trim() !== '' && 
                               linkageInput.value.trim() !== '' && 
                               exactAccountNameInput.value.trim() !== '';
            }
            
            // Validar si el ID de usuario contiene solo números (aplicar solo a campos de ID)
            let isUserIdNumeric = true;
            if (idNameInputs.style.display === 'block' && userIdInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdInput.value.trim());
            } else if (idServerInputs.style.display === 'block' && userIdServerInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdServerInput.value.trim());
            } else if (idOnlyInputs.style.display === 'block' && userIdOnlyInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdOnlyInput.value.trim());
            }
            
            const allValid = gameSelected && amountSelected && countrySelected && 
                             userInfoValid && isUserIdNumeric;
            
            // Verificar si estamos en el último paso (paso 6)
            const currentStep = document.querySelector('.form-step.active');
            const isLastStep = currentStep && currentStep.id === 'step6';
            
            // Solo mostrar el botón de enviar pedido en el último paso
            if (isLastStep) {
                // En el último paso, validamos todo
                const completeValid = allValid && sellerSelected;
                sendWhatsAppOrderBtn.disabled = !completeValid;
                sendWhatsAppOrderBtn.style.display = 'block';
            } else {
                // En cualquier otro paso, ocultamos el botón de enviar pedido
                sendWhatsAppOrderBtn.style.display = 'none';
            }
            
            if (!allValid) {
                if (!countrySelected) {
                    showMessage('Por favor, selecciona tu país para continuar.', 'info');
                } else if (!isUserIdNumeric && (userIdInput && userIdInput.value.trim() || userIdServerInput && userIdServerInput.value.trim() || userIdOnlyInput && userIdOnlyInput.value.trim())) {
                    showMessage('El ID de Usuario (o UID) solo debe contener números.', 'error');
                } else if (!messageDisplay.textContent || messageDisplay.style.display === 'none') {
                    showMessage('Por favor, completa todos los campos necesarios para enviar el pedido.', 'info');
                }
            } else {
                messageDisplay.style.display = 'none';
            }
        }


        // Función para cargar los botones de juego
        function loadGameOptions() {
            gameButtonsContainer.innerHTML = ''; 
            gameOptions.forEach(game => {
                const gameItemDiv = document.createElement('div');
                gameItemDiv.classList.add('game-item');
                gameItemDiv.dataset.gameName = game.name;

                const imgElement = document.createElement('img');
                imgElement.src = game.logoUrl || 'https://placehold.co/120x120/cccccc/000000?text=No Image'; 
                imgElement.alt = `Logo de ${game.name}`;
                imgElement.classList.add('game-logo');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = 'https://placehold.co/120x120/cccccc/000000?text=No Image'; 
                    console.error('Failed to load game logo image:', game.logoUrl);
                };

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('game-name-label');
                nameSpan.textContent = game.name;

                gameItemDiv.appendChild(imgElement);
                gameItemDiv.appendChild(nameSpan);

                gameItemDiv.addEventListener('click', () => {
                    selectedGame = game.name;
                    selectedAmount = null; // Limpiar artículo seleccionado al cambiar de juego
                    
                    Array.from(gameButtonsContainer.children).forEach(div => div.classList.remove('selected'));
                    gameItemDiv.classList.add('selected');

                    updateAmountSelection(); 
                    updatePriceSummary();
                    updateInputFields(); // Actualiza los campos de entrada al seleccionar un juego
                    messageDisplay.style.display = 'none';
                    transferWarningMessage.style.display = 'block';
                    updateSendOrderButtonState();

                    // Avanzar automáticamente al paso 3
                    showStep(3);
                });
                gameButtonsContainer.appendChild(gameItemDiv);
            });
        }

        // Función para actualizar los botones de monto con imágenes y precio local
        function updateAmountSelection() {
            amountButtonsDiv.innerHTML = ''; 
            if (selectedGame) {
                amountSelectionDiv.style.display = 'block'; 
                const currentAmounts = gameOptions.find(g => g.name === selectedGame)?.amounts;
                const countryInfo = countryData.find(c => c.name === selectedCountry) || defaultCountryInfo; 

                if (currentAmounts && currentAmounts.length > 0) {
                    currentAmounts.forEach(amount => {
                        const itemDiv = document.createElement('div'); 
                        itemDiv.classList.add('amount-item'); // Ahora amount-item ya tiene los estilos base
                        // Guardar todos los datos del artículo en el dataset para fácil recuperación
                        itemDiv.dataset.value = amount.value; 
                        itemDiv.dataset.label = amount.label; 
                        itemDiv.dataset.imageUrl = amount.imageUrl; 

                        const imgElement = document.createElement('img');
                        imgElement.src = amount.imageUrl;
                        imgElement.alt = amount.label;
                        imgElement.classList.add('item-image');
                        imgElement.width = 80;
                        imgElement.height = 80;
                        imgElement.loading = 'lazy'; 
                        
                        imgElement.onerror = function() {
                            this.onerror = null; 
                            this.src = 'https://placehold.co/80x80/cccccc/000000?text=No Image'; 
                            console.error('Failed to load item image:', amount.imageUrl);
                        };

                        const itemTextContainer = document.createElement('div'); 
                        itemTextContainer.classList.add('item-text-container');

                        const labelSpan = document.createElement('span');
                        labelSpan.classList.add('item-label');
                        labelSpan.textContent = amount.label;

                        // Verificar si está en promoción y agregar badge
                        const promoInfo = getPromotionInfo(selectedGame, amount.label);
                        if (promoInfo) {
                            itemDiv.classList.add('promo-item', promoInfo.animation);
                            const promoBadge = document.createElement('span');
                            promoBadge.classList.add('promo-badge');
                            promoBadge.textContent = promoInfo.badge;
                            itemDiv.appendChild(promoBadge);
                        }

                        itemTextContainer.appendChild(labelSpan);

                        // Lógica condicional para mostrar el precio: USD o moneda local
                        if (selectedCountry === '') {
                            // Mostrar solo precio en USD si no hay país seleccionado
                            const priceUsdSpan = document.createElement('span');
                            priceUsdSpan.classList.add('item-price-usd');
                            priceUsdSpan.textContent = `${amount.value.toFixed(2)} USD`; 
                            itemTextContainer.appendChild(priceUsdSpan);
                        } else {
                            // Mostrar precio en moneda local si hay país seleccionado
                            const priceLocalSpan = document.createElement('span');
                            priceLocalSpan.classList.add('item-price-local');
                            const localPrice = amount.value * countryInfo.exchangeRate;
                            priceLocalSpan.textContent = `${formatNumber(localPrice)} ${countryInfo.symbol}`; 
                            itemTextContainer.appendChild(priceLocalSpan);
                        }
                        
                        itemDiv.appendChild(imgElement);
                        itemDiv.appendChild(itemTextContainer); 

                        itemDiv.addEventListener('click', (e) => {
                            // Prevenir que el click en el badge de promoción interfiera
                            e.stopPropagation();
                            
                            // Deseleccionar todos los demás artículos
                            Array.from(amountButtonsDiv.children).forEach(div => div.classList.remove('selected'));
                            
                            // Seleccionar solo este artículo
                            itemDiv.classList.add('selected');
                            selectedAmount = amount; // Almacenar el objeto del artículo seleccionado

                            updatePriceSummary();
                            messageDisplay.style.display = 'none'; 
                            transferWarningMessage.style.display = 'block'; 
                            updateSendOrderButtonState();

                            // Avanzar automáticamente al paso 4
                            showStep(4);
                        });

                        // Marcar como seleccionado si es el artículo actualmente seleccionado
                        if (selectedAmount && selectedAmount.value === amount.value && selectedAmount.label === amount.label) {
                            itemDiv.classList.add('selected');
                        }

                        amountButtonsDiv.appendChild(itemDiv);
                    });
                } else {
                    amountButtonsDiv.innerHTML = '<p style="color: #FF6347; font-weight: bold;">No hay artículos disponibles para este juego.</p>';
                }
            } else {
                amountSelectionDiv.style.display = 'none'; 
            }
        }

        // Función para cargar opciones de país como botones
        function loadCountryOptions() {
            countrySelectContainer.innerHTML = ''; // Limpiar botones existentes
            countryData.forEach(country => {
                const countryItemDiv = document.createElement('div');
                countryItemDiv.classList.add('country-item');
                countryItemDiv.dataset.countryName = country.name;

                const imgElement = document.createElement('img');
                imgElement.src = country.imageUrl || `https://placehold.co/60x60/CCCCCC/000000?text=${country.code}`; // Usar código si no hay URL
                imgElement.alt = `Bandera de ${country.name}`;
                imgElement.classList.add('country-image');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = `https://placehold.co/60x60/CCCCCC/000000?text=${country.code}`; 
                    console.error('Failed to load country image:', country.imageUrl);
                };

                countryItemDiv.appendChild(imgElement);
                // No se añade el nombre del país debajo de la imagen según la solicitud

                countryItemDiv.addEventListener('click', () => {
                    selectedCountry = country.name;
                    // Deseleccionar todos los demás países
                    Array.from(countrySelectContainer.children).forEach(div => div.classList.remove('selected'));
                    countryItemDiv.classList.add('selected');
                    
                    updatePriceSummary(); // Actualizar el resumen con la nueva moneda
                    if (selectedGame) { // Si ya hay un juego seleccionado, actualizar los precios de los artículos
                        updateAmountSelection(); 
                    }
                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();

                    // Avanzar automáticamente al paso 2
                    showStep(2);
                });
                countrySelectContainer.appendChild(countryItemDiv);
            });
            selectedCountry = ''; // Asegurarse de que no haya país preseleccionado al cargar
        }

        // Función para cargar opciones de vendedor como botones
        function loadSellerOptions() {
            sellerSelectContainer.innerHTML = ''; // Limpiar botones existentes
            sellerData.forEach(seller => {
                const sellerItemDiv = document.createElement('div');
                sellerItemDiv.classList.add('seller-item');
                sellerItemDiv.dataset.sellerName = seller.name;

                const imgElement = document.createElement('img');
                imgElement.src = seller.imageUrl || 'https://placehold.co/60x60/CCCCCC/000000?text=V'; // Placeholder si no hay imagen
                imgElement.alt = `Foto de ${seller.name}`;
                imgElement.classList.add('seller-image');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = 'https://placehold.co/60x60/CCCCCC/000000?text=V'; 
                    console.error('Failed to load seller image:', seller.imageUrl);
                };

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('seller-name-label');
                nameSpan.textContent = seller.name;

                if (seller.name === 'XJoseDharckX') {
                    nameSpan.classList.add('highlighted-seller');
                }

                sellerItemDiv.appendChild(imgElement);
                sellerItemDiv.appendChild(nameSpan);

                sellerItemDiv.addEventListener('click', () => {
                    selectedSeller = seller.name;
                    // Deseleccionar todos los demás vendedores
                    Array.from(sellerSelectContainer.children).forEach(div => div.classList.remove('selected'));
                    sellerItemDiv.classList.add('selected');

                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();

                    // Avanzar automáticamente al paso 6 (ahora combinado con el paso 7)
                    showStep(6);
                });
                sellerSelectContainer.appendChild(sellerItemDiv);
            });
            selectedSeller = ''; // Asegurarse de que no haya vendedor preseleccionado al cargar
        }

        // Función: Actualiza la visibilidad y requisitos de los campos de entrada
        function updateInputFields() {
            idNameInputs.style.display = 'none';
            idServerInputs.style.display = 'none';
            idOnlyInputs.style.display = 'none';
            codInputs.style.display = 'none';
            document.getElementById('mlNameInput').style.display = 'none'; 

            const allInputs = [
                userIdInput, userNameInput, userIdServerInput, serverInput, userNameMLInput,
                userIdOnlyInput, emailInput, passwordInput, linkageInput, exactAccountNameInput
            ];
            allInputs.forEach(input => {
                if (input) { 
                    input.value = '';
                    input.required = false;
                }
            });

            const currentGame = gameOptions.find(g => g.name === selectedGame);
            if (!currentGame) return;

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    idNameInputs.style.display = 'block';
                    userIdInput.required = true;
                    userNameInput.required = true;
                    break;
                case 'id_server':
                    idServerInputs.style.display = 'block';
                    userIdServerInput.required = true;
                    serverInput.required = true;
                    break;
                case 'id_server_name': 
                    idServerInputs.style.display = 'block';
                    userIdServerInput.required = true;
                    serverInput.required = true;
                    document.getElementById('mlNameInput').style.display = 'block'; 
                    userNameMLInput.required = true;
                    break;
                case 'id_only':
                    idOnlyInputs.style.display = 'block';
                    userIdOnlyInput.required = true;
                    break;
                case 'cod_full':
                    codInputs.style.display = 'block';
                    emailInput.required = true;
                    passwordInput.required = true;
                    linkageInput.required = true;
                    exactAccountNameInput.required = true;
                    break;
                default:
                    break;
            }
            updateSendOrderButtonState(); 
        }


        // Referencias a los nuevos elementos
        const toStep5Button = document.getElementById('toStep5');
        const orderStatusPage = document.getElementById('orderStatusPage');
        const orderStatusMessage = document.getElementById('orderStatusMessage');
        const closeStatusPageButton = document.getElementById('closeStatusPage');

        // Event listener para el botón Siguiente en el paso 4
        if (toStep5Button) {
            toStep5Button.addEventListener('click', () => {
                // Verificar si todos los campos requeridos están completos
                const currentGame = gameOptions.find(g => g.name === selectedGame);
                if (!currentGame) return;
                
                let userInfoValid = false;
                if (idNameInputs.style.display === 'block') {
                    userInfoValid = userIdInput.value.trim() !== '' && userNameInput.value.trim() !== '';
                } else if (idServerInputs.style.display === 'block') {
                    const mlNameValid = document.getElementById('mlNameInput').style.display === 'block' ? 
                        userNameMLInput.value.trim() !== '' : true;
                    userInfoValid = userIdServerInput.value.trim() !== '' && serverInput.value.trim() !== '' && mlNameValid;
                } else if (idOnlyInputs.style.display === 'block') {
                    userInfoValid = userIdOnlyInput.value.trim() !== '';
                } else if (codInputs.style.display === 'block') {
                    userInfoValid = emailInput.value.trim() !== '' && 
                                   passwordInput.value.trim() !== '' && 
                                   linkageInput.value.trim() !== '' && 
                                   exactAccountNameInput.value.trim() !== '';
                }
                
                // Validar si el ID de usuario contiene solo números
                let isUserIdNumeric = true;
                if (idNameInputs.style.display === 'block' && userIdInput.value.trim() !== '') {
                    isUserIdNumeric = /^[0-9]*$/.test(userIdInput.value.trim());
                } else if (idServerInputs.style.display === 'block' && userIdServerInput.value.trim() !== '') {
                    isUserIdNumeric = /^[0-9]*$/.test(userIdServerInput.value.trim());
                } else if (idOnlyInputs.style.display === 'block' && userIdOnlyInput.value.trim() !== '') {
                    isUserIdNumeric = /^[0-9]*$/.test(userIdOnlyInput.value.trim());
                }
                
                if (userInfoValid && isUserIdNumeric) {
                    showStep(5);
                } else {
                    if (!isUserIdNumeric && (userIdInput.value.trim() || userIdServerInput.value.trim() || userIdOnlyInput.value.trim())) {
                        showMessage('El ID de Usuario (o UID) solo debe contener números.', 'error');
                    } else {
                        showMessage('Por favor, completa todos los campos necesarios para continuar.', 'info');
                    }
                }
            });
        }

        // Event listener para el botón de cerrar la página de estado
        if (closeStatusPageButton) {
            closeStatusPageButton.addEventListener('click', () => {
                orderStatusPage.style.display = 'none';
            });
        }

        // Función para actualizar el estado del botón Siguiente en el paso 4
        function updateStep4NextButton() {
            const toStep5Button = document.getElementById('toStep5');
            if (!toStep5Button) return;
            
            let userInfoValid = false;
            if (idNameInputs.style.display === 'block') {
                userInfoValid = userIdInput.value.trim() !== '' && userNameInput.value.trim() !== '';
            } else if (idServerInputs.style.display === 'block') {
                const mlNameValid = document.getElementById('mlNameInput').style.display === 'block' ? 
                    userNameMLInput.value.trim() !== '' : true;
                userInfoValid = userIdServerInput.value.trim() !== '' && serverInput.value.trim() !== '' && mlNameValid;
            } else if (idOnlyInputs.style.display === 'block') {
                userInfoValid = userIdOnlyInput.value.trim() !== '';
            } else if (codInputs.style.display === 'block') {
                userInfoValid = emailInput.value.trim() !== '' && 
                               passwordInput.value.trim() !== '' && 
                               linkageInput.value.trim() !== '' && 
                               exactAccountNameInput.value.trim() !== '';
            }
            
            let isUserIdNumeric = true;
            if (idNameInputs.style.display === 'block' && userIdInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdInput.value.trim());
            } else if (idServerInputs.style.display === 'block' && userIdServerInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdServerInput.value.trim());
            } else if (idOnlyInputs.style.display === 'block' && userIdOnlyInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdOnlyInput.value.trim());
            }
            
            toStep5Button.disabled = !(userInfoValid && isUserIdNumeric);
            
            // Asegurar que el botón sea siempre visible
            toStep5Button.style.display = 'block';
            toStep5Button.style.visibility = 'visible';
        }

        // Manejadores de input para validar y restablecer botones
        [userIdInput, userNameInput, userIdServerInput, serverInput, userNameMLInput, userIdOnlyInput,
         emailInput, passwordInput, linkageInput, exactAccountNameInput].forEach(input => {
            if (input) { 
                input.addEventListener('input', () => {
                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();
                    updateStep4NextButton(); // Actualizar el estado del botón Siguiente
                });
            }
        });



        // Manejador de cambio de vendedor (AHORA MANEJADO POR CLICK EN BOTONES)
        // Ya no es necesario sellerSelect.addEventListener('change', ...)
        
        // Manejador de cambio de país (AHORA MANEJADO POR CLICK EN BOTONES)
        // Ya no es necesario countrySelect.addEventListener('change', ...)
        
        // Función para actualizar el resumen del precio y los métodos de pago
        function updatePriceSummary() {
            // selectedAmount ahora es un objeto o null
            let selectedAmountUSD = selectedAmount ? selectedAmount.value : 0;

            if (selectedAmountUSD > 0 && selectedCountry) {
                const countryInfo = countryData.find(country => country.name === selectedCountry); 
                
                if (!countryInfo) {
                    priceSummaryDiv.style.display = 'none'; 
                    paymentMethodsDisplayDiv.style.display = 'none'; 
                    selectedItemsPreview.innerHTML = ''; 
                    return;
                }

                totalPrice = selectedAmountUSD * countryInfo.exchangeRate;
                currencySymbol = countryInfo.symbol;
                
                totalPriceDisplay.textContent = formatNumber(totalPrice); 
                currencySymbolDisplay.textContent = currencySymbol;
                baseAmountDisplay.textContent = selectedAmountUSD.toFixed(2);
                priceSummaryDiv.style.display = 'block'; 

                // Mostrar miniatura del artículo seleccionado (singular)
                selectedItemsPreview.innerHTML = '';
                if (selectedAmount) {
                    const img = document.createElement('img');
                    img.src = selectedAmount.imageUrl;
                    img.alt = selectedAmount.label;
                    img.title = selectedAmount.label; 
                    img.classList.add('selected-item-thumbnail');
                    img.onerror = function() {
                        this.onerror = null; 
                        this.src = 'https://placehold.co/50x50/cccccc/000000?text=No Image'; 
                        console.error('Failed to load thumbnail image:', selectedAmount.imageUrl);
                    };
                    selectedItemsPreview.appendChild(img);
                }

                // Mostrar métodos de pago para el país seleccionado
                paymentMethodsListDiv.innerHTML = '';
                if (countryInfo.paymentMethods && countryInfo.paymentMethods.length > 0) {
                    paymentMethodsDisplayDiv.style.display = 'block'; 
                    countryInfo.paymentMethods.forEach(method => {
                        const p = document.createElement('p');
                        p.innerHTML = `<span>${method.name}:</span> ${method.details}`;
                        paymentMethodsListDiv.appendChild(p);
                    });

                    sendWhatsAppOrderBtn.style.display = 'block';
                } else {
                    paymentMethodsDisplayDiv.style.display = 'none'; 

                    sendWhatsAppOrderBtn.style.display = 'none';
                }

            } else {
                priceSummaryDiv.style.display = 'none'; 
                paymentMethodsDisplayDiv.style.display = 'none'; 

                selectedItemsPreview.innerHTML = ''; 
            }
        }

        // Función para mostrar un paso específico
function showStep(stepNumber) {
    // Ocultar todos los pasos
    document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Mostrar el paso solicitado
    const targetStep = document.getElementById(`step${stepNumber}`);
    if (targetStep) {
        targetStep.classList.add('active');
        // Actualizar la barra de progreso (ahora con 6 pasos en total en lugar de 7)
        const progressBar = document.getElementById('formProgress');
        if (progressBar) {
            progressBar.style.width = `${(stepNumber / 6) * 100}%`;
        }
        
        // Asegurar que el botón Siguiente en el paso 4 esté visible y funcional
        if (stepNumber === 4) {
            const toStep5Button = document.getElementById('toStep5');
            if (toStep5Button) {
                toStep5Button.style.display = 'block';
                toStep5Button.style.visibility = 'visible';
                updateStep4NextButton();
            }
        }
        
        // NUEVA LÍNEA: Actualizar el estado del botón de envío cuando se navega a cualquier paso
        updateSendOrderButtonState();
        
        // Desplazamiento suave al inicio del paso
        targetStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

        // Función para mostrar mensajes al usuario
        function showMessage(msg, type) {
            messageDisplay.textContent = msg;
            messageDisplay.style.display = 'block'; 
            messageDisplay.classList.remove('message-error', 'message-success', 'message-info'); 

            if (type === 'error') {
                messageDisplay.classList.add('message-error');
            } else if (type === 'success') {
                messageDisplay.classList.add('message-success');
            } else if (type === 'info') {
                messageDisplay.classList.add('message-info');
            }
        }

        // Función para mostrar el modal de advertencia de WhatsApp
        function showWhatsAppWarningModal() {
            whatsappWarningModal.style.display = 'flex'; 
            messageDisplay.style.display = 'none'; 
        }

        // Función para ocultar el modal de advertencia de WhatsApp
        function hideWhatsAppWarningModal() {
            whatsappWarningModal.style.display = 'none'; 
        }




        // Manejador del envío del formulario (modificado para WhatsApp) - ahora activado por sendWhatsAppOrderBtn
        topupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (sendWhatsAppOrderBtn.disabled) {
                return;
            }
            
            // Realizar validaciones finales antes de mostrar el modal
            if (!selectedCountry) { showMessage('Por favor, selecciona tu país para continuar.', 'error'); return; }
            const currentGame = gameOptions.find(g => g.name === selectedGame);
            if (!currentGame) { showMessage('Por favor, selecciona un juego.', 'error'); return; }
            if (selectedAmount === null) { showMessage('Por favor, selecciona un artículo/monto.', 'error'); return; }

            let isValid = true;
            let errorMessage = '';

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    if (!userIdInput.value.trim() || !userNameInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa tu ID y Nombre de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El ID de Jugador solo debe contener números.';
                    }
                    break;
                case 'id_server':
                    if (!userIdServerInput.value.trim() || !serverInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa el UID y el Servidor.';
                    } else if (!/^[0-9]*$/.test(userIdServerInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El UID solo debe contener números.';
                    }
                    break;
                case 'id_server_name': 
                    if (!userIdServerInput.value.trim() || !serverInput.value.trim() || !userNameMLInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa la ID, el Servidor y el Nombre de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdServerInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'La ID solo debe contener números.';
                    }
                    break;
                case 'id_only':
                    if (!userIdOnlyInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa tu ID de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdOnlyInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El ID de Jugador solo debe contener números.';
                    }
                    break;
                case 'cod_full':
                    if (!emailInput.value.trim() || !passwordInput.value.trim() || !linkageInput.value.trim() || !exactAccountNameInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, completa todos los campos de Call of Duty Mobile.';
                    } else if (!emailInput.value.includes('@')) { 
                        isValid = false;
                        errorMessage = 'Por favor, ingresa un correo electrónico válido.';
                    }
                    break;
                default:
                    isValid = false;
                    errorMessage = 'Tipo de juego no reconocido o campos incompletos.';
                    break;
            }

            if (!isValid) {
                showMessage(errorMessage, 'error');
                return;
            }

            if (!selectedSeller) { showMessage('Por favor, selecciona un vendedor.', 'error'); return; }
            
            showWhatsAppWarningModal();
        });

        // Oyente de eventos para el botón "Confirmar y Enviar" en el modal (este es el que realmente envía a WhatsApp)
        confirmWhatsAppBtn.addEventListener('click', async () => {
            hideWhatsAppWarningModal(); 
            loadingOverlay.style.display = 'flex'; 
            
            // Mostrar la página de estado
            orderStatusPage.style.display = 'flex';
            
            // Simular verificación del estado (en una implementación real, esto se haría con una llamada a la API)
            // Por ahora, simplemente mostramos "En proceso"
            orderStatusMessage.textContent = 'En proceso';
            orderStatusMessage.classList.remove('delivered');
            

            gameHidden.value = selectedGame;
            amountUSDHidden.value = selectedAmount ? selectedAmount.value : ''; 
            totalPriceHidden.value = totalPrice;
            currencySymbolHidden.value = currencySymbol;

            // Generar información del artículo seleccionado para el mensaje de WhatsApp
            const selectedItemForWhatsapp = selectedAmount ? 
                `- ${selectedAmount.label} (${selectedAmount.value.toFixed(2)} USD / ${formatNumber(selectedAmount.value * (countryData.find(c => c.name === selectedCountry) || defaultCountryInfo).exchangeRate)} ${(countryData.find(c => c.name === selectedCountry) || defaultCountryInfo).symbol})` : 
                'No se seleccionó ningún artículo.';

            const sellerInfo = sellerData.find(seller => seller.name === selectedSeller);
            const whatsappRecipientNumber = sellerInfo ? sellerInfo.phoneNumber : DEFAULT_WHATSAPP_NUMBER; 
            
            let playerInfo = '';
            const currentGame = gameOptions.find(g => g.name === selectedGame);

            if (currentGame) {
                switch (currentGame.inputRequirement) {
                    case 'id_name':
                        playerInfo = `🆔 *ID del Jugador*: ${userIdInput.value.trim()}\n👤 *Nombre del Jugador*: ${userNameInput.value.trim()}`;
                        break;
                    case 'id_server':
                        playerInfo = `🆔 *UID*: ${userIdServerInput.value.trim()}\n🌐 *Servidor*: ${serverInput.value.trim()}`;
                        break;
                    case 'id_server_name': 
                        playerInfo = `🆔 *ID del Jugador*: ${userIdServerInput.value.trim()}\n🌐 *Servidor*: ${serverInput.value.trim()}\n👤 *Nombre del Jugador*: ${userNameMLInput.value.trim()}`;
                        break;
                    case 'id_only':
                        playerInfo = `🆔 *ID del Jugador*: ${userIdOnlyInput.value.trim()}`;
                        break;
                    case 'cod_full':
                        playerInfo = `📧 *Correo*: ${emailInput.value.trim()}\n🔑 *Contraseña*: ${passwordInput.value.trim()}\n🔗 *Vinculación*: ${linkageInput.value.trim()}\n📝 *Nombre Exacto*: ${exactAccountNameInput.value.trim()}`;
                        break;
                    default:
                        playerInfo = 'Información del jugador no disponible.';
                        break;
                }
            }

            const whatsappMessageContent =
                `📝 *Pedido de Recarga - DHARCK STORE*:\n\n` +
                `${playerInfo}\n` + 
                `💼 *Vendedor*: ${selectedSeller}\n` + 
                `🎮 *Juego*: ${selectedGame}\n` +
                `🛒 *Artículo Seleccionado*:\n${selectedItemForWhatsapp}\n` + 
                `💸 *Total a Pagar*: ${formatNumber(totalPrice)} ${currencySymbol}\n` + 
                `  _(Base: ${(selectedAmount ? selectedAmount.value : 0).toFixed(2)} USD + comisión)_\n` + 
                `🌎 *País*: ${selectedCountry}\n\n` +
                `⚠️ *¡Importante!*: Por favor, envíame el comprobante de pago.`;

            // -----------------------------------------------------
            // Crear orden pendiente en el backend
            // -----------------------------------------------------
            const countryInfo = countryData.find(c => c.name === selectedCountry);
            
            // Mapear correctamente los datos según el tipo de juego
            let playerId = '';
            let playerName = '';
            let playerEmail = '';
            let additionalInfo = '';

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    playerId = userIdInput.value.trim();
                    playerName = userNameInput.value.trim();
                    break;
                case 'id_server':
                    playerId = userIdServerInput.value.trim();
                    additionalInfo = serverInput.value.trim();
                    break;
                case 'id_server_name':
                    playerId = userIdServerInput.value.trim();
                    playerName = userNameMLInput.value.trim();
                    additionalInfo = serverInput.value.trim();
                    break;
                case 'id_only':
                    playerId = userIdOnlyInput.value.trim();
                    break;
                case 'cod_full':
                    playerEmail = emailInput.value.trim();
                    playerName = exactAccountNameInput.value.trim();
                    additionalInfo = `Contraseña: ${passwordInput.value.trim()}, Vinculación: ${linkageInput.value.trim()}`;
                    break;
            }

            const orderData = {
                sellerName: selectedSeller,
                gameName: selectedGame,
                itemLabel: selectedAmount ? selectedAmount.label : 'N/A',
                amountUSD: selectedAmount ? selectedAmount.value : 0,
                totalPrice: totalPrice,
                currencySymbol: countryInfo ? countryInfo.symbol : currencySymbol,
                playerId: playerId,
                playerName: playerName,
                playerEmail: playerEmail,
                additionalInfo: additionalInfo,
                countryName: selectedCountry
            };

            try {
                const BASE_API_URL = window.location.origin + '/api';
                const response = await fetch(`${BASE_API_URL}/pending-orders`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error al crear la orden pendiente:', errorText);
                    showMessage('Error al registrar la orden en el servidor. Por favor, avisa al soporte.', 'error');
                } else {
                    showMessage('Orden registrada exitosamente y preparando WhatsApp...', 'success');
                }
            } catch (error) {
                console.error('Error de red al intentar crear la orden:', error);
                showMessage('Error de conexión al servidor al intentar registrar la orden.', 'error');
            }
            // -----------------------------------------------------
            // FIN: Creación de orden pendiente
            // -----------------------------------------------------

            // Abrir WhatsApp en una nueva pestaña/ventana
            window.open(`https://wa.me/${whatsappRecipientNumber}?text=${encodeURIComponent(whatsappMessageContent)}`, '_blank');

            // Después de un breve retraso, ocultar la animación de carga y mostrar el mensaje de éxito
            setTimeout(() => {
                loadingOverlay.style.display = 'none'; 
                showMessage('¡Pedido registrado exitosamente! Será procesado por nuestro equipo y entregado en 5-15 minutos.', 'success'); 

                // Opcional: Limpiar el formulario después de un envío exitoso
                topupForm.reset();
                selectedGame = '';
                selectedAmount = null; 
                selectedCountry = ''; 
                // No necesitamos countrySelect.value = ''; ni sellerSelect.value = ''; porque ya no son <select>
                selectedSeller = ''; 
                priceSummaryDiv.style.display = 'none'; 
                paymentMethodsDisplayDiv.style.display = 'none'; 
                amountSelectionDiv.style.display = 'none'; 
                amountButtonsDiv.innerHTML = '';
                selectedItemsPreview.innerHTML = ''; 
                
                // Quitar la clase 'selected' de todos los botones de juego, país, vendedor y ocultar campos de usuario
                Array.from(gameButtonsContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(countrySelectContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(sellerSelectContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(amountButtonsDiv.children).forEach(div => div.classList.remove('selected'));
                updateInputFields(); 

                transferWarningMessage.style.display = 'block'; 
                updateSendOrderButtonState(); 
            }, 2000); 
        });

        // Oyente de eventos para el botón "Cancelar" en el modal
        cancelWhatsAppBtn.addEventListener('click', () => {
            hideWhatsAppWarningModal(); 
            showMessage('Envío de pedido cancelado.', 'info');
        });

       // Función para cargar configuración de artículos desde servidor o localStorage
        async function loadArticlesConfig() {
            try {
                // Agregar timestamp para evitar caché del navegador
                const timestamp = new Date().getTime();
                const BASE_API_URL = window.location.origin;
                const response = await fetch(`${BASE_API_URL}/api/articles-config?t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const serverConfig = await response.json();
                    
                    if (serverConfig && Object.keys(serverConfig).length > 0) {
                        // Convertir configuración del servidor a formato gameOptions
                        gameOptions = Object.keys(serverConfig).map(gameName => {
                            const gameConfig = serverConfig[gameName];
                            const activeArticles = gameConfig.articles.filter(article => article.active);
                            
                            return {
                                name: gameName,
                                logoUrl: gameConfig.logoUrl,
                                inputRequirement: gameConfig.inputRequirement,
                                amounts: activeArticles.map(article => ({
                                    value: article.value,
                                    label: article.label,
                                    imageUrl: article.imageUrl || '/image/prize-2.png',
                                    promotion: article.promotion
                                }))
                            };
                        }).filter(game => game.amounts.length > 0); // Solo juegos con artículos activos
                        
                        // Actualizar localStorage con la nueva configuración
                        localStorage.setItem('gameArticlesConfig', JSON.stringify(serverConfig));
                        console.log('Configuración cargada desde servidor:', gameOptions.length, 'juegos activos');
                        
                        // IMPORTANTE: Re-renderizar la interfaz después de cargar
                        if (typeof loadGameOptions === 'function') {
                            loadGameOptions();
                        }
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error cargando desde servidor:', error);
            }
            
            // Fallback a localStorage
            const savedConfig = localStorage.getItem('gameArticlesConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    gameOptions = Object.keys(config).map(gameName => {
                        const gameConfig = config[gameName];
                        const activeArticles = gameConfig.articles.filter(article => article.active);
                        
                        return {
                            name: gameName,
                            logoUrl: gameConfig.logoUrl,
                            inputRequirement: gameConfig.inputRequirement,
                            amounts: activeArticles.map(article => ({
                                value: article.value,
                                label: article.label,
                                imageUrl: article.imageUrl || '/image/prize-2.png',
                                promotion: article.promotion
                            }))
                        };
                    }).filter(game => game.amounts.length > 0);
                    
                    console.log('Configuración cargada desde localStorage:', gameOptions.length, 'juegos activos');
                    
                    // Re-renderizar la interfaz
                    if (typeof loadGameOptions === 'function') {
                        loadGameOptions();
                    }
                    
                    return true;
                } catch (parseError) {
                    console.error('Error parseando localStorage:', parseError);
                    gameOptions = [];
                }
            }
            
            return false;
        }

        // Optimizar carga de configuración de artículos
        const optimizedLoadArticlesConfig = debounce(async function() {
            try {
                const response = await fetch('/api/articles-config');
                if (response.ok) {
                    const serverConfig = await response.json();
                    
                    // Verificar si hay cambios antes de actualizar
                    const currentConfig = localStorage.getItem('gameArticlesConfig');
                    const newConfig = JSON.stringify(serverConfig);
                    
                    if (currentConfig !== newConfig) {
                        localStorage.setItem('gameArticlesConfig', newConfig);
                        
                        // Actualizar gameOptions solo si es necesario
                        const oldLength = gameOptions.length;
                        gameOptions = Object.keys(serverConfig).map(gameName => {
                            const gameConfig = serverConfig[gameName];
                            const activeArticles = gameConfig.articles.filter(article => article.active);
                            
                            return {
                                name: gameName,
                                logoUrl: gameConfig.logoUrl,
                                inputRequirement: gameConfig.inputRequirement,
                                amounts: activeArticles.map(article => ({
                                    value: article.value,
                                    label: article.label,
                                    imageUrl: article.imageUrl || '/image/prize-2.png',
                                    promotion: article.promotion
                                }))
                            };
                        }).filter(game => game.amounts.length > 0);
                        
                        // Solo re-renderizar si cambió el número de juegos
                        if (oldLength !== gameOptions.length && typeof loadGameOptions === 'function') {
                            loadGameOptions();
                        }
                    }
                }
            } catch (error) {
                console.warn('Error cargando configuración:', error);
            }
        }, 5000); // Esperar 5 segundos antes de ejecutar

        // Función para refrescar configuración (llamar desde consola para debug)
        window.refreshArticlesConfig = async function() {
            console.log('Refrescando configuración de artículos...');
            await loadArticlesConfig();
            console.log('Configuración actualizada. Juegos disponibles:', gameOptions.length);
        };

        // Función de debug para verificar configuración
        window.debugArticles = function() {
            console.log('=== DEBUG CONFIGURACIÓN DE ARTÍCULOS ===');
            console.log('gameOptions:', gameOptions);
            console.log('localStorage gameArticlesConfig:', localStorage.getItem('gameArticlesConfig'));
            
            // Verificar cada juego
            gameOptions.forEach(game => {
                console.log(`${game.name}: ${game.amounts.length} artículos activos`);
                game.amounts.forEach(article => {
                    console.log(`  - ${article.label}: $${article.value}`);
                });
            });
        };

        // Función para limpiar caché y recargar
        window.clearCacheAndReload = function() {
            localStorage.removeItem('gameArticlesConfig');
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            window.location.reload(true);
        };

        console.log('Funciones de debug disponibles:');
        console.log('- window.debugArticles() - Ver configuración actual');
        console.log('- window.refreshArticlesConfig() - Refrescar desde servidor');
        console.log('- window.clearCacheAndReload() - Limpiar caché y recargar');
        console.log('- window.togglePromotion(key, true/false) - Activar/desactivar promociones');
        console.log('- window.getPromotionStatus() - Ver estado de promociones');
        
        // Exponer funciones de promoción globalmente para debug
        window.togglePromotion = togglePromotion;
        window.getPromotionStatus = getPromotionStatus;

        // Auto-refresh optimizado - solo cada 5 minutos en lugar de 2
        intervals.articlesConfig = setInterval(optimizedLoadArticlesConfig, 300000); // 5 minutos

        // Inicializar la página cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando aplicación optimizada...');
            
            // Configurar lazy loading
            setupLazyLoading();
            
            // Optimizar imágenes existentes
            optimizeImages();
            
            // Cargar configuración de artículos PRIMERO
            const configLoaded = await loadArticlesConfig();
            console.log('Configuración de artículos cargada:', configLoaded);
            
            // Luego cargar el resto
            await loadExchangeRates();
            loadCountryOptions();
            loadGameOptions();
            loadSellerOptions();
            updateSendOrderButtonState();
            updateInputFields();
            updateStep4NextButton();
            
            // Intervalo optimizado para tasas de cambio - cada 10 minutos
            intervals.exchangeRates = setInterval(optimizedLoadExchangeRates, 600000); // 10 minutos
            
            console.log('Aplicación inicializada completamente');
        });

        // Limpiar intervalos al salir de la página
        window.addEventListener('beforeunload', () => {
            clearAllIntervals();
        });

        // Pausar intervalos cuando la página no está visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearAllIntervals();
            } else {
                // Reactivar intervalos cuando la página vuelve a ser visible
                intervals.exchangeRates = setInterval(optimizedLoadExchangeRates, 600000);
                intervals.articlesConfig = setInterval(optimizedLoadArticlesConfig, 300000);
            }
        });

    </script>
    
    <!-- Service Worker Registration Optimizado -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registrado:', registration);
                
                // Verificar actualizaciones solo cada 10 minutos en lugar de 30 segundos
                intervals.serviceWorker = setInterval(() => {
                    registration.update();
                }, 600000); // 10 minutos
                
                // Escuchar actualizaciones del service worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Hay una nueva versión disponible - no mostrar popup automático
                            console.log('Nueva versión disponible en segundo plano');
                            
                            // Opcional: mostrar notificación discreta
                            const notification = document.createElement('div');
                            notification.style.cssText = `
                                position: fixed;
                                top: 10px;
                                right: 10px;
                                background: #4CAF50;
                                color: white;
                                padding: 10px;
                                border-radius: 5px;
                                font-size: 12px;
                                z-index: 10000;
                                opacity: 0;
                                transition: opacity 0.3s;
                            `;
                            notification.textContent = 'Nueva versión disponible';
                            document.body.appendChild(notification);
                            
                            setTimeout(() => notification.style.opacity = '1', 100);
                            setTimeout(() => {
                                notification.style.opacity = '0';
                                setTimeout(() => notification.remove(), 300);
                            }, 3000);
                        }
                    });
                });
            })
            .catch(error => {
                console.log('Error registrando Service Worker:', error);
            });
    }
    </script>
    <!-- Página de estado del pedido -->
    <div id="orderStatusPage" class="order-status-page">
        <div class="order-status-container">
            <h2>Estado de su pedido</h2>
            <div class="loader"></div>
            <div id="orderStatusMessage" class="status-message">En proceso</div>
            <button id="closeStatusPage" class="close-button">Cerrar</button>
        </div>
    </div>
    
    <!-- Botón de soporte técnico fijo -->
    <div class="fixed-support-button">
        <button onclick="window.open('https://wa.me/584126027407?text=Hola,%20necesito%20soporte%20t%C3%A9cnico%20de%20Dharck%20Store.', '_blank')">
            <svg class="support-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.55 3.64 1.5 5.11L2 22l4.89-1.5C8.36 21.45 10.11 22 12 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm-1 16h2v-2h-2v2zm2-4h-2c0-3.25 3-3 3-5 0-1.1-.9-2-2-2s-2 .9-2 2h-2c0-2.21 1.79-4 4-4s4 1.79 4 4c0 2.5-3 2.75-3 5z"/>
            </svg>
            <span>Soporte</span>
        </button>
    </div>
    
    <!-- Pie de página con derechos de autor -->
    <footer class="footer">
        <p>© 2025 DHARCK STORE. Todos los derechos reservados.</p>
        <p>Creado por <span class="highlight">XJoseDharckX</span>, Dueño de Dharck Store.</p>
    </footer>
</body>
</html>