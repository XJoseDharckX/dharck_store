<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECARGAS DHARCK STORE</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="/image/logo1.png" type="image/png">
    
    <!-- Version Control -->
    <script src="/version.js"></script>
<!-- Google tag (gtag.js) -->S
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RB1V3F1WL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RB1V3F1WL');
</script>

</head>
<body>

    <style>
     
    </style>

    <!-- Header para el tÃ­tulo de la aplicaciÃ³n -->
    <header class="app-header">
        <div class="dharck-store-title-container">
            <h1 class="dharck-store-title">
                DHARCK STORE
            </h1>
            <!-- La ruta /logo.png asume que 'logo.png' estÃ¡ directamente en la carpeta 'public/' en tu proyecto de Vercel. -->
            <img src="/image/logo.png" alt="Logotipo de la TIENDA DHARCK" class="title-logo">    
        </div>
        <!-- BOTÃ“N DE SOPORTE TÃ‰CNICO AÃ‘ADIDO AQUÃ -->
        <button class="support-button" onclick="window.open('https://wa.me/584126027407?text=Hola,%20necesito%20soporte%20t%C3%A9cnico%20de%20Dharck%20Store.', '_blank')">
            <svg class="support-icon" viewBox="0 0 24 24">
                <path d="M12 2C6.477 2 2 6.477 2 12c0 3.313 1.606 6.279 4.093 8.163L4.5 22.5l2.25-1.5c1.844.975 3.966 1.547 6.25 1.547C17.523 22.5 22 18.023 22 12S17.523 2 12 2zm2.25 10.5H9.75v-1.5h4.5v1.5z"/>
            </svg>
            Soporte TÃ©cnico
        </button>
    </header>

    <!-- Nuevo contenedor para la selecciÃ³n de paÃ­s - MOVIDO ARRIBA -->
    <div class="section-container" id="countrySelectionSection">
        <div class="form-group">
            <label for="country">
                SELECCIONA TU PAIS:
            </label>
            <div id="countryButtonsContainer">
                <!-- Los botones de paÃ­s se generarÃ¡n aquÃ­ con JS -->
            </div>
        </div>
    </div>

    <!-- Nuevo contenedor para la selecciÃ³n de juegos -->
    <div class="section-container" id="gameSelectionSection">
        <div class="form-group">
            <label>
                SELECCIONA EL JUEGO:
            </label>
            <div id="gameButtonsContainer">
                <!-- Los botones de juego se generarÃ¡n aquÃ­ con JS -->
            </div>
        </div>
    </div>

    <!-- Contenedor principal del formulario, ahora contiene los artÃ­culos, campos de usuario, vendedor y resumen de pedido -->
    <div class="form-container">
        <form id="topupForm">
            <div id="amountSelection" class="form-group" style="display: none;">
                <label>
                    SELECCIONA EL ARTICULO(S):
                </label>
                <div id="amountButtons">
                    <!-- Los divs de los artÃ­culos se generarÃ¡n aquÃ­ con JS -->
                </div>
            </div>

            <!-- SecciÃ³n de informaciÃ³n del jugador, contendrÃ¡ los campos dinÃ¡micos -->
            <div id="userInfoSection">
                <!-- ID y Nombre (Para Lords Mobile, Free Fire, Mobile Legends) -->
                <div id="idNameInputs" style="display: none;">
                    <div class="form-group">
                        <label for="userId">
                            ID DEL JUGADOR:
                        </label>
                        <input
                            type="tel"
                            id="userId"
                            name="userId"
                            placeholder="Ej: 1234567890"
                            pattern="[0-9]*"
                            title="Por favor, ingresa solo nÃºmeros."
                        />
                    </div>
                    <div class="form-group">
                        <label for="userName">
                            NOMBRE DEL JUGADOR:
                        </label>
                        <input
                            type="text"
                            id="userName"
                            name="userName"
                            placeholder="Ej: ElCojeViejas300"
                        />
                    </div>
                </div>

                <!-- ID y Servidor (Para Genshin Impact, Mobile Legends) -->
                <div id="idServerInputs" style="display: none;">
                    <div class="form-group">
                        <label for="userIdServer">
                            ID DEL JUGADOR (UID):
                        </label>
                        <input
                            type="tel"
                            id="userIdServer"
                            name="userIdServer"
                            placeholder="Ej: 123456789 (UID)"
                            pattern="[0-9]*"
                            title="Por favor, ingresa solo nÃºmeros para el UID."
                        />
                    </div>
                    <div class="form-group">
                        <label for="serverInput">
                            SERVIDOR:
                        </label>
                        <input
                            type="text"
                            id="serverInput"
                            name="serverInput"
                            placeholder="Ej: AmÃ©rica, Asia, Europa"
                        />
                    </div>
                    <!-- Nombre del jugador para Mobile Legends, si aplica en este grupo -->
                    <div class="form-group" id="mlNameInput" style="display: none;">
                        <label for="userNameML">
                            NOMBRE DEL JUGADOR:
                        </label>
                        <input
                            type="text"
                            id="userNameML"
                            name="userNameML"
                            placeholder="Ej: MiNombreDeML"
                        />
                    </div>
                </div>

                <!-- ID Solamente (Para Blood Strike, PUBG Mobile, Delta Force) -->
                <div id="idOnlyInputs" style="display: none;">
                    <div class="form-group">
                        <label for="userIdOnly">
                            ID DEL JUGADOR:
                        </label>
                        <input
                            type="tel"
                            id="userIdOnly"
                            name="userIdOnly"
                            placeholder="Ej: 1234567890"
                            pattern="[0-9]*"
                            title="Por favor, ingresa solo nÃºmeros."
                        />
                    </div>
                </div>

                <!-- Campos completos para Call of Duty Mobile -->
                <div id="codInputs" style="display: none;">
                    <div class="form-group">
                        <label for="emailInput">
                            CORREO ELECTRÃ“NICO:
                        </label>
                        <input
                            type="email"
                            id="emailInput"
                            name="emailInput"
                            placeholder="Ej: tu_correo@example.com"
                        />
                    </div>
                    <div class="form-group">
                        <label for="passwordInput">
                            CONTRASEÃ‘A:
                        </label>
                        <input
                            type="password"
                            id="passwordInput"
                            name="passwordInput"
                            placeholder="Ingresa tu contraseÃ±a"
                        />
                    </div>
                    <div class="form-group">
                        <label for="linkageInput">
                            VINCULACIÃ“N (Gmail, Facebook, Activision):
                        </label>
                        <input
                            type="text"
                            id="linkageInput"
                            name="linkageInput"
                            placeholder="Ej: Gmail"
                        />
                    </div>
                    <div class="form-group">
                        <label for="exactAccountNameInput">
                            NOMBRE EXACTO DE LA CUENTA:
                        </label>
                        <input
                            type="text"
                            id="exactAccountNameInput"
                            name="exactAccountNameInput"
                            placeholder="Ej: TuNombreExactoEnCOD"
                        />
                    </div>
                </div>
            </div> <!-- Fin de userInfoSection -->

            <div class="form-group">
                <label for="seller">
                    SELECCIONA EL VENDEDOR:
                </label>
                <div id="sellerButtonsContainer">
                    <!-- Los botones de vendedor se generarÃ¡n aquÃ­ con JS -->
                </div>
            </div>

            <!-- La selecciÃ³n de paÃ­s se moviÃ³ a la parte superior -->
            <input type="hidden" id="gameHidden" name="game">
            <input type="hidden" id="amountUSDHidden" name="amountUSD">
            <input type="hidden" id="totalPriceHidden" name="totalPrice">
            <input type="hidden" id="currencySymbolHidden" name="currencySymbol">


            <div id="priceSummary" style="display: none;">
                <p>RESUMEN DE PEDIDO:</p>
                <div id="selectedItemsPreview">
                    <!-- Las miniaturas de los artÃ­culos seleccionados se mostrarÃ¡n aquÃ­ -->
                </div>
                <p>
                    TOTAL A PAGAR: <span id="totalPriceDisplay"></span> <span id="currencySymbolDisplay"></span>
                </p>
                <p>
                    (BASADO EN <span id="baseAmountDisplay"></span> USD + COMISION!)
                </p>
            </div>

            <div id="paymentMethodsDisplay" style="display: none;">
                <p>METODOS DE PAGOS:</p>
                <div id="paymentMethodsList"></div>
            </div>



            <!-- Mensaje de advertencia actualizado -->
            <div id="transferWarningMessage" class="transfer-warning">
                Â¡Importante! AsegÃºrate de haber realizado el pago antes de enviar el pedido. La entrega puede demorar entre 5 a 15 minutos en reflejarse en el juego.
            </div>

            <!-- Solo un botÃ³n de envÃ­o -->
            <button
                type="submit"
                id="sendWhatsAppOrderBtn"
                class="action-button"
                style="display: none;"
                disabled="true"
            >
                ENVIAR PEDIDO
            </button>

            <div id="messageDisplay" style="display: none;"></div>
        </form>
    </div>

    <div id="whatsappWarningModal" style="position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none;">
        <div style="background-color: rgba(10, 0, 30, 0.95); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 100%; text-align: center;">
            <h2>Â¡Importante!</h2>
            <p style="color: #e0f2fe;">
                Tu pedido serÃ¡ enviado por WhatsApp.
                <span style="color: #ff00ff;">Recuerda realizar el pago usando los mÃ©todos mostrados y enviar el comprobante por WhatsApp.</span>
            </p>
            <div>
                <button id="cancelWhatsApp" type="button">
                    Cancelar
                </button>
                <button id="confirmWhatsApp" type="button">
                    Confirmar y Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (NUEVO) -->
    <div id="loadingOverlay" style="position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 1001; color: white; display: none;">
        <div class="spinner" style="border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #00ffff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px; font-size: 1.2em; color: #00ffff; text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);" class="loading-text">Cargando...</p>
    </div>

    <script type="module">

        // NÃºmero de WhatsApp Business predeterminado (fallback si no se encuentra el vendedor)
        const DEFAULT_WHATSAPP_NUMBER = '584126027407'; 

        // ConfiguraciÃ³n de ganancias por artÃ­culo (SOLO PARA ADMINISTRADORES - NO VISIBLE AL PÃšBLICO)
        const SELLER_PROFIT_CONFIG = {
            'FREE FIRE': 0.40,
            'DELTA FORCE STEAM': 0.60, 
            'DELTA FORCE GARENA': 0.60,
            'CALL OF DUTY MOBILE': 0.70,
            'PUBG MOBILE': 0.50,
            'MOBILE LEGENDS': 0.45,
            'DEFAULT': 0.50
        };

        // Elementos ocultos (ahora solo para datos del formulario)
        const gameHidden = document.getElementById('gameHidden');
        const amountUSDHidden = document.getElementById('amountUSDHidden');
        const totalPriceHidden = document.getElementById('totalPriceHidden');
        const currencySymbolHidden = document.getElementById('currencySymbolHidden');


        // Referencias al modal
        const whatsappWarningModal = document.getElementById('whatsappWarningModal');
        const confirmWhatsAppBtn = document.getElementById('confirmWhatsApp');
        const cancelWhatsAppBtn = document.getElementById('cancelWhatsApp');

        // BotÃ³n de acciÃ³n
        const sendWhatsAppOrderBtn = document.getElementById('sendWhatsAppOrderBtn');
        const loadingOverlay = document.getElementById('loadingOverlay'); // Referencia al overlay de carga

        // Elementos del DOM para campos dinÃ¡micos
        const countrySelectionSection = document.getElementById('countrySelectionSection'); // Nueva secciÃ³n para paÃ­s
        const gameSelectionSection = document.getElementById('gameSelectionSection');
        const amountSelectionDiv = document.getElementById('amountSelection');
        const userInfoSection = document.getElementById('userInfoSection'); // Nuevo contenedor para todos los campos de usuario
        const idNameInputs = document.getElementById('idNameInputs');
        const userIdInput = document.getElementById('userId'); 
        const userNameInput = document.getElementById('userName'); 

        const idServerInputs = document.getElementById('idServerInputs');
        const userIdServerInput = document.getElementById('userIdServer');
        const serverInput = document.getElementById('serverInput');
        const userNameMLInput = document.getElementById('userNameML'); 

        const idOnlyInputs = document.getElementById('idOnlyInputs');
        const userIdOnlyInput = document.getElementById('userIdOnly');

        const codInputs = document.getElementById('codInputs');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const linkageInput = document.getElementById('linkageInput');
        const exactAccountNameInput = document.getElementById('exactAccountNameInput');


        // FunciÃ³n para verificar si un artÃ­culo estÃ¡ en promociÃ³n
        function isArticleInPromotion(gameName, articleLabel) {
            // Buscar en gameOptions cargados desde el servidor
            const game = gameOptions.find(g => g.name === gameName);
            if (!game) return false;
            
            const article = game.amounts.find(a => a.label === articleLabel);
            return article ? article.promotion : false;
        }

        // FunciÃ³n para obtener informaciÃ³n de promociÃ³n
        function getPromotionInfo(gameName, articleLabel) {
            if (isArticleInPromotion(gameName, articleLabel)) {
                return {
                    type: 'PROMO',
                    badge: 'ðŸ”¥PROMO',
                    animation: 'promo-pulse'
                };
            }
            return null;
        }

        // Datos de juegos y sus precios base en USD
        // Se aÃ±ade 'logoUrl' para cada juego para los botones.
        // NOTA: AsegÃºrate de que todas las imÃ¡genes referenciadas aquÃ­ (logoUrl y imageUrl)
        // existan en tu carpeta 'public/image/' en Vercel y que estÃ©n optimizadas (comprimidas)
        // para una carga rÃ¡pida de la pÃ¡gina.
        let gameOptions = [
            {
                name: 'LORDS MOBILE',
                logoUrl: '/image/lm1.png',
                inputRequirement: 'id_name',
                amounts: [
//                    { label: 'ðŸ’Ž499+CUPON', value: 5.20, imageUrl: '/image/prize-2.png', promotion: false },
//                    { label: 'ðŸ’Ž999+CUPON', value: 12.00, imageUrl: '/image/prize-3.png', promotion: false },
                    { label: 'ðŸ’Ž1999+CUPON', value: 20.00, imageUrl: '/image/prize-4.png', promotion: false },
//                    { label: 'ðŸ’Ž2499+CUPON', value: 25.50, imageUrl: '/image/prize-5.png', promotion: false },
//                    { label: 'ðŸ’Ž2999+CUPON', value: 30.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: 'ðŸ’Ž4999+CUPON', value: 48.50, imageUrl: '/image/prize-7.png', promotion: false },
  //                  { label: 'ðŸ’Ž9999+CUPON', value: 95.00, imageUrl: '/image/icon-happy.png', promotion: false },
                    { label: 'PASE SEMANAL', value: 2.30, imageUrl: '/image/7day.png', promotion: false },
                    { label: 'PASE MENSUAL', value: 19.90, imageUrl: '/image/30day.png', promotion: false },
                    { label: '209ðŸ’Ž', value: 2.30, imageUrl: '/image/prize-2.png', promotion: false },
                    { label: '524ðŸ’Ž', value: 5.20, imageUrl: '/image/prize-3.png', promotion: false },
                    { label: '1048ðŸ’Ž', value: 10.00, imageUrl: '/image/prize-4.png', promotion: false },
                    { label: '2096ðŸ’Ž', value: 19.50, imageUrl: '/image/prize-5.png', promotion: false },
                    { label: '3144ðŸ’Ž', value: 29.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '5240ðŸ’Ž', value: 48.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '6812ðŸ’Ž', value: 62.00, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: '9956ðŸ’Ž', value: 92.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '19912ðŸ’Ž', value: 178.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '30392ðŸ’Ž', value: 270.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: '50304ðŸ’Ž', value: 440.00, imageUrl: '/image/icon-happy.png', promotion: false }
                ]
            },
            {
                name: 'BLOOD STRIKE',
                logoUrl: '/image/bs.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '100+5', value: 0.89, imageUrl: '/image/100.png', promotion: false },
                    { label: '300+20', value: 2.50, imageUrl: '/image/300.png', promotion: false },
                    { label: '500+40', value: 4.30, imageUrl: '/image/500.png', promotion: false },
                    { label: '1000+100', value: 8.50, imageUrl: '/image/1000.png', promotion: false },
                    { label: '2000+200', value: 17.60, imageUrl: '/image/2000.png', promotion: false },
                    { label: '5000+800', value: 42.00, imageUrl: '/image/5000.png', promotion: false },
                    { label: 'PASE ELITE', value: 3.50, imageUrl: '/image/elite.png', promotion: false },
                    { label: 'PASE PREMIUM', value: 8.51, imageUrl: '/image/premium.png', promotion: false },
                    { label: 'PASE DE NIVEL', value: 2.00, imageUrl: '/image/mejora.png', promotion: false }
                ]
            },
            {
                name: 'FREE FIRE',
                logoUrl: '/image/ff1.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: 'ðŸ’ŽSEMANAL', value: 1.80, imageUrl: '/image/ffs.png', promotion: false },
                    { label: 'ðŸ’ŽMENSUAL', value: 9.50, imageUrl: '/image/ffm.png', promotion: false },
                    { label: 'ðŸ’Ž100+10', value: 0.99, imageUrl: '/image/prize-2.png', promotion: false },
                    { label: 'ðŸ’Ž200+20', value: 1.90, imageUrl: '/image/prize-3.png', promotion: false },
                    { label: 'ðŸ’Ž310+31', value: 2.80, imageUrl: '/image/prize-4.png', promotion: false },
                    { label: 'ðŸ’Ž520+52', value: 4.60, imageUrl: '/image/prize-5.png', promotion: false },
                    { label: 'ðŸ’Ž1069+106', value: 9.50, imageUrl: '/image/prize-6.png', promotion: false },
                    { label: 'ðŸ’Ž2180+218', value: 18.00, imageUrl: '/image/prize-7.png', promotion: false },
                    { label: 'ðŸ’Ž5600+560', value: 40.00, imageUrl: '/image/prize-7.png', promotion: false }
                ]
            },
            {
                name: 'GENSHIN IMPACT',
                logoUrl: '/image/gi.png',
                inputRequirement: 'id_server',
                amounts: [
                    { label: 'PASE LUNAR', value: 4.8, imageUrl: '/image/bl.png', promotion: false },
                    { label: '60', value: 0.90, imageUrl: '/image/cg1.png', promotion: false },
                    { label: '300+30', value: 4.70, imageUrl: '/image/cg2.png', promotion: false },
                    { label: '980+110', value: 13.00, imageUrl: '/image/cg3.png', promotion: false },
                    { label: '1980+260', value: 27.00, imageUrl: '/image/cg4.png', promotion: false },
                    { label: '3280+600', value: 45.50, imageUrl: '/image/cg5.png', promotion: false },
                    { label: '6480+1600', value: 90.00, imageUrl: '/image/cg6.png', promotion: false }
                ]
            },
            {
                name: 'PUBG MOBILE',
                logoUrl: '/image/pm1.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60', value: 0.99, imageUrl: '/image/pm.png', promotion: false },
                    { label: '300+25', value: 4.85, imageUrl: '/image/pm.png', promotion: false },
                    { label: '600+60', value: 9.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '1500+300', value: 23.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '3000+850', value: 45.00, imageUrl: '/image/pm.png', promotion: false },
                    { label: '6000+2100', value: 92.00, imageUrl: '/image/pm.png', promotion: false }
                ]
            },
            {
                name: 'DELTA FORCE STEAM',
                logoUrl: '/image/dfss.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60 Coins', value: 0.99, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '300+20 Coins', value: 4.70, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '420+40 Coins', value: 6.80, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '680+70 Coins', value: 9.00, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '1280+200 Coins', value: 17.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '1680+300 Coins', value: 21.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '3280+670 Coins', value: 40.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '6480+1620 Coins', value: 80.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '12960+3240 Coins', value: 174.00, imageUrl: '/image/dfs5.png', promotion: false },
                    { label: '19440+4860 Coins', value: 260.00, imageUrl: '/image/dfs5.png', promotion: false }
                ]
            },
            {
                name: 'DELTA FORCE GARENA',
                logoUrl: '/image/dfsg.png',
                inputRequirement: 'id_only',
                amounts: [
                    { label: '60 Coins', value: 0.99, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '300+36 Coins', value: 4.80, imageUrl: '/image/dfs1.png', promotion: false },
                    { label: '420+62 Coins', value: 7.00, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '680+105 Coins', value: 9.60, imageUrl: '/image/dfs2.png', promotion: false },
                    { label: '1280+264 Coins', value: 19.00, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '1680+385 Coins', value: 23.50, imageUrl: '/image/dfs3.png', promotion: false },
                    { label: '3280+834 Coins', value: 45.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '6480+1944 Coins', value: 88.00, imageUrl: '/image/dfs4.png', promotion: false },
                    { label: '12960+3888 Coins', value: 180.00, imageUrl: '/image/dfs5.png', promotion: false },
                    { label: '19440+5832 Coins', value: 270.00, imageUrl: '/image/dfs5.png', promotion: false }
                ]
            },
            {
                name: 'CALL OF DUTY MOBILE',
                logoUrl: '/image/codm.png',
                inputRequirement: 'cod_full',
                amounts: [
                    { label: '80 CP', value: 1.50, imageUrl: '/image/cm1.png', promotion: false },
                    { label: '420 CP', value: 5.50, imageUrl: '/image/cm1.png', promotion: false },
                    { label: '880 CP', value: 11.00, imageUrl: '/image/cm2.png', promotion: false },
                    { label: '2400 CP', value: 26.00, imageUrl: '/image/cm2.png', promotion: false },
                    { label: '5000 CP', value: 55.00, imageUrl: '/image/cm4.png', promotion: false },
                    { label: '10800 CP', value: 110.00, imageUrl: '/image/cm4.png', promotion: false }
                ]
            },
            {
                name: 'MOBILE LEGENDS',
                logoUrl: '/image/ml.png',
                inputRequirement: 'id_server_name',
                amounts: [
                    { label: 'PASE SEMANAL ML', value: 1.60, imageUrl: '/image/ml7.png', promotion: false },
                    { label: 'CREPUSCULAR', value: 9.50, imageUrl: '/image/ml7.png', promotion: false },
                    { label: '50+5ðŸ’Ž', value: 0.90, imageUrl: '/image/ml1.png', promotion: false },
                    { label: '150+15ðŸ’Ž', value: 2.80, imageUrl: '/image/ml1.png', promotion: false },
                    { label: '250+25ðŸ’Ž', value: 4.40, imageUrl: '/image/ml2.png', promotion: false },
                    { label: '500+65ðŸ’Ž', value: 8.30, imageUrl: '/image/ml2.png', promotion: false },
                    { label: '625+81ðŸ’Ž', value: 10.00, imageUrl: '/image/ml3.png', promotion: false },
                    { label: '940+144ðŸ’Ž', value: 18.00, imageUrl: '/image/ml3.png', promotion: false },
                    { label: '1860+335ðŸ’Ž', value: 27.50, imageUrl: '/image/ml4.png', promotion: false },
                    { label: '3099+589ðŸ’Ž', value: 44.20, imageUrl: '/image/ml4.png', promotion: false },
                    { label: '4649+883ðŸ’Ž', value: 65.40, imageUrl: '/image/ml5.png', promotion: false },
                    { label: '7740+1548ðŸ’Ž', value: 110.00, imageUrl: '/image/ml6.png', promotion: false }
                ]
            }
        ];

        // Datos de paÃ­ses y tasas de cambio - AHORA SE CARGAN DINÃMICAMENTE
        let countryData = [
            // Datos por defecto que se actualizarÃ¡n desde la API
            {
                name: 'VENEZUELA',
                code: 'VES',
                exchangeRate: 144.5,
                symbol: 'Bs.',
                imageUrl: '/image/paises/ve.png',
                paymentMethods: [
                    { name: 'Pago MÃ³vil', details: 'C.I.: V-32147818, TelÃ©fono: 04126027407, Banco: 0105 (Banco Mercantil)' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'COLOMBIA',
                code: 'COP',
                exchangeRate: 4150,
                symbol: 'COP',
                imageUrl: '/image/paises/co.png',
                paymentMethods: [
                    { name: 'Nequi', details: 'NÃºmero: 3012660676 Nombre:Ali.' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'PERU',
                code: 'PEN',
                exchangeRate: 3.85,
                symbol: 'S/.',
                imageUrl: '/image/paises/pe.png',
                paymentMethods: [
                    { name: 'BCP', details: 'Cuenta: 38097062947042, Titular: Yoshimara' },
                    { name: 'Yape', details: 'NÃºmero: 974610375' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'MEXICO',
                code: 'MXN',
                exchangeRate: 20,
                symbol: 'MXN',
                imageUrl: '/image/paises/mx.png',
                paymentMethods: [
                    { name: 'SPIN BY OXXO', details: 'TARJETA: 4217 4701 8364 0099' },
                    { name: 'BANCO AZTECA', details: 'INTERBANCARIA: 1277 9700 1467 5859 00' },
                    { name: 'Titular', details: 'Jesus Carrillo' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ESTADOS UNIDOS',
                code: 'USD',
                exchangeRate: 1.05,
                symbol: '$',
                imageUrl: '/image/paises/us.png',
                paymentMethods: [
                    { name: 'Zelle', details: '+1 (661) 736 - 0564, Nombre: Jannett Martinez Lopez' },
                    { name: 'Titular', details: 'Jannett Martinez Lopez' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ARGENTINA',
                code: 'ARS',
                exchangeRate: 1320,
                symbol: '$',
                imageUrl: '/image/paises/ar.png',
                paymentMethods: [
                    { name: 'Mercado pago', details: '0000003100069089540216' },
                    { name: 'UALA', details: '3840200500000000199867' },
                    { name: 'Titular', details: 'Pamela Schneider' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'ECUADOR',
                code: 'USD',
                exchangeRate: 1.06,
                symbol: '$',
                imageUrl: '/image/paises/ec.png',
                paymentMethods: [
                    { name: 'Banco Pichincha', details: 'Cta. ahorros 2204277346' },
                    { name: 'Banco de Guayaquil', details: 'Cta. ahorros 0039924590' },
                    { name: 'Titular', details: 'MarÃ­a de los Ãngeles Ronquillo LeÃ³n. CI: 0941414203' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            {
                name: 'CHILE',
                code: 'CLP',
                exchangeRate: 1010,
                symbol: '$',
                imageUrl: '/image/paises/cl.png',
                paymentMethods: [
                    { name: 'BANCO FALABELLA', details: 'RUT: 17244216-1 / gi553ll30@gmail.com / Cta Corriente: 1-983-036407-8' },
                    { name: 'BANCO ESTADO', details: 'RUT: 17244216-1 / Cta Corriente: 37100135052 / 300 PESOS EXTRAS AL VALOR TOTAL'},
                    { name: 'Titular', details: 'GISSELLE GONZALEZ'},
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!'},
                ]
            },
            {
                name: 'ESPAÃ‘A',
                code: 'EUR',
                exchangeRate: 1.04,
                symbol: 'â‚¬',
                imageUrl: '/image/paises/es.png',
                paymentMethods: [
                    { name: 'BIZUM', details: '612237372 / 614153840 / CUALQUIERA DE LOS DOS' },
                    { name: 'BANCO SANTANDER', details: 'Cuenta bancaria : ES0800495939582916425258' },
                    { name: 'Titular', details: 'MAX FRANCIS SILVA RAMOS' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'COSTA RICA',
                code: 'CRC',
                exchangeRate: 600,
                symbol: 'â‚¡',
                imageUrl: '/image/paises/cr.png',
                paymentMethods: [
                    { name: 'SIMPE', details: '63223852' },
                    { name: 'Titular', details: 'Solange Granja Duarte' },
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'BOLIVIA',
                code: 'BOB',
                exchangeRate: 15.5,
                symbol: 'Bs.',
                imageUrl: '/image/paises/bo.png',
                paymentMethods: [
                    { name: 'Banco ganadero', details: '1311307078' }, 
                    { name: 'Tigo Money', details: '69172559' }, 
                    { name: 'Titular', details: 'Brandon Salazar GutiÃ©rrez'}, 
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
            { 
                name: 'NICARAGUA',
                code: 'NIO',
                exchangeRate: 43.5,
                symbol: 'C$',
                imageUrl: '/image/paises/ni.png',
                paymentMethods: [
                    { name: 'BAC CÃ“RDOBAS', details: 'Email: Nomiflores72@gmail.com' }, 
                    { name: 'Cta. ahorros:', details: '363278672' }, 
                    { name: 'Titular', details: 'Nahomi Flores VelÃ¡squez'}, 
                    { name: 'Â¡IMPORTANTE!', details: 'Â¡No colocar conceptos EN LOS PAGOS!' },
                ]
            },
        ];

        // FunciÃ³n para cargar tasas de cambio actualizadas desde la API
        async function loadExchangeRates() {
            try {
                const BASE_API_URL = window.location.origin;
                const response = await fetch(`${BASE_API_URL}/api/get-exchange-rates`);
                if (response.ok) {
                    const updatedRates = await response.json();
                    
                    // Actualizar las tasas de cambio manteniendo los demÃ¡s datos
                    countryData = countryData.map(country => {
                        const updatedCountry = updatedRates.find(rate => rate.name === country.name);
                        if (updatedCountry) {
                            return {
                                ...country,
                                exchangeRate: updatedCountry.exchangeRate
                            };
                        }
                        return country;
                    });
                    
                    console.log('Tasas de cambio actualizadas exitosamente');
                    
                    // Actualizar la interfaz si hay un paÃ­s seleccionado
                    if (selectedCountry) {
                        updatePriceDisplay();
                    }
                } else {
                    console.log('No se pudieron cargar las tasas actualizadas, usando valores por defecto');
                }
            } catch (error) {
                console.log('Error al cargar tasas de cambio:', error);
                console.log('Usando tasas de cambio por defecto');
            }
        }

        // FunciÃ³n para actualizar la visualizaciÃ³n de precios
        function updatePriceDisplay() {
            if (selectedAmount && selectedCountry) {
                const countryInfo = countryData.find(c => c.name === selectedCountry) || defaultCountryInfo;
                totalPrice = selectedAmount.value * countryInfo.exchangeRate;
                currencySymbol = countryInfo.symbol;
                
                totalPriceDisplay.textContent = formatNumber(totalPrice);
                currencySymbolDisplay.textContent = currencySymbol;
                baseAmountDisplay.textContent = selectedAmount.value.toFixed(2);
            }
        }

        // Datos de vendedores (RUTAS DE IMAGEN Y RECOMENDACIÃ“N DE TAMAÃ‘O ACTUALIZADAS)
        // RECOMENDACIÃ“N DE TAMAÃ‘O DE IMAGEN PARA VENDEDORES: Se recomienda usar imÃ¡genes cuadradas (ej. 60x60px o 80x80px)
        // para los logos/fotos de los vendedores. Esto asegura que se vean bien en los botones circulares.
        // AsegÃºrate de que los nombres de archivo coincidan con los nombres aquÃ­ (e.g., 'xjosdharckx.png').
        const sellerData = [
            { name: 'XJoseDharckX', phoneNumber: '584126027407', imageUrl: '/image/vendedores/xjosedharckx.png' }, // Ruta actualizada
            { name: 'Miguel', phoneNumber: '5214951219766', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'Alfredo Favier', phoneNumber: '5353148505', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'Candy Candy', phoneNumber: '584144274483', imageUrl: '/image/vendedores/david.png' }, // Ruta actualizada
            { name: 'Satoru', phoneNumber: '5491170897494', imageUrl: '/image/vendedores/satoru.png' }, // Ruta actualizada
            { name: 'Ernesto', phoneNumber: '573025129990', imageUrl: '/image/vendedores/ernesto.png' }, // Ruta actualizada
            { name: 'OSCAR', phoneNumber: '573002030533', imageUrl: '/image/vendedores/logo1.png' }, // Ruta actualizada
            { name: 'SpartanoWolf98', phoneNumber: '584262276868', imageUrl: '/image/vendedores/SpartanoWolf98.png' }, // Nuevo vendedor agregado
            { name: 'Jhack', phoneNumber: '584247582765', imageUrl: '/image/vendedores/Jhack.png' }, // Nuevo vendedor
            { name: 'Enmanuel', phoneNumber: '50586521013', imageUrl: '/image/vendedores/Enmanuel.png' }, // NUEVO VENDEDOR
            // Puedes aÃ±adir mÃ¡s vendedores aquÃ­ si es necesario
        ];

        let selectedGame = '';
        let selectedAmount = null; // Un solo artÃ­culo seleccionado (objeto)
        let selectedCountry = ''; 
        let selectedSeller = ''; 
        let totalPrice = 0;
        let currencySymbol = 'USD';
        // Se asegura que defaultCountryInfo exista, usando un valor por defecto si no se encuentra 'USD'
        let defaultCountryInfo = countryData.find(c => c.code === 'USD') || { name: 'ESTADOS UNIDOS', code: 'USD', exchangeRate: 1.00, symbol: '$', paymentMethods: [], imageUrl: '/image/paises/US.png' };


        const countrySelectContainer = document.getElementById('countryButtonsContainer'); 
        const gameButtonsContainer = document.getElementById('gameButtonsContainer');
        const amountButtonsDiv = document.getElementById('amountButtons');
        const sellerSelectContainer = document.getElementById('sellerButtonsContainer'); 
        const priceSummaryDiv = document.getElementById('priceSummary');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const currencySymbolDisplay = document.getElementById('currencySymbolDisplay');
        const baseAmountDisplay = document.getElementById('baseAmountDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const topupForm = document.getElementById('topupForm');
        const paymentMethodsDisplayDiv = document.getElementById('paymentMethodsDisplay');
        const paymentMethodsListDiv = document.getElementById('paymentMethodsList');
        const transferWarningMessage = document.getElementById('transferWarningMessage');
        const selectedItemsPreview = document.getElementById('selectedItemsPreview'); // Contenedor para miniaturas


        // FunciÃ³n para formatear nÃºmeros con separadores de miles y decimales (puntos y comas)
        function formatNumber(num) {
            // Convierte el nÃºmero a una cadena con 2 decimales
            let formattedNum = num.toFixed(2);
            // Separa la parte entera de la parte decimal
            let parts = formattedNum.split('.');
            // Formatea la parte entera con puntos como separador de miles
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            // Junta las partes con coma como separador decimal
            return parts.join(',');
        }

        // FunciÃ³n para validar todos los campos y habilitar/deshabilitar el botÃ³n de Enviar Pedido
        function updateSendOrderButtonState() {
            const gameSelected = selectedGame !== '';
            const amountSelected = selectedAmount !== null;
            const countrySelected = selectedCountry !== '';
            const sellerSelected = selectedSeller !== '';
            
            // Validar comprobante de pago - ya no es necesario
            let paymentProofSelected = true; // Siempre true ya que no requerimos comprobante
            
            // Validar campos especÃ­ficos del juego
            let userInfoValid = false;
            if (idNameInputs.style.display === 'block') {
                userInfoValid = userIdInput.value.trim() !== '' && userNameInput.value.trim() !== '';
            } else if (idServerInputs.style.display === 'block') {
                const mlNameValid = document.getElementById('mlNameInput').style.display === 'block' ? 
                    userNameMLInput.value.trim() !== '' : true;
                userInfoValid = userIdServerInput.value.trim() !== '' && serverInput.value.trim() !== '' && mlNameValid;
            } else if (idOnlyInputs.style.display === 'block') {
                userInfoValid = userIdOnlyInput.value.trim() !== '';
            } else if (codInputs.style.display === 'block') {
                userInfoValid = emailInput.value.trim() !== '' && 
                               passwordInput.value.trim() !== '' && 
                               linkageInput.value.trim() !== '' && 
                               exactAccountNameInput.value.trim() !== '';
            }
            
            // Validar si el ID de usuario contiene solo nÃºmeros (aplicar solo a campos de ID)
            let isUserIdNumeric = true;
            if (idNameInputs.style.display === 'block' && userIdInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdInput.value.trim());
            } else if (idServerInputs.style.display === 'block' && userIdServerInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdServerInput.value.trim());
            } else if (idOnlyInputs.style.display === 'block' && userIdOnlyInput.value.trim() !== '') {
                isUserIdNumeric = /^[0-9]*$/.test(userIdOnlyInput.value.trim());
            }
            
            const allValid = gameSelected && amountSelected && countrySelected && 
                             sellerSelected && userInfoValid && isUserIdNumeric;
            
            sendWhatsAppOrderBtn.disabled = !allValid;
            
            // Solo mostrar el botÃ³n si hay mÃ©todos de pago visibles
            if (paymentMethodsDisplayDiv.style.display === 'block') {
                sendWhatsAppOrderBtn.style.display = 'block';
            } else {
                sendWhatsAppOrderBtn.style.display = 'none';
            }
            
            if (!allValid) {
                if (!countrySelected) {
                    showMessage('Por favor, selecciona tu paÃ­s para continuar.', 'info');
                } else if (!isUserIdNumeric && (userIdInput && userIdInput.value.trim() || userIdServerInput && userIdServerInput.value.trim() || userIdOnlyInput && userIdOnlyInput.value.trim())) {
                    showMessage('El ID de Usuario (o UID) solo debe contener nÃºmeros.', 'error');
                } else if (!messageDisplay.textContent || messageDisplay.style.display === 'none') {
                    showMessage('Por favor, completa todos los campos necesarios para enviar el pedido.', 'info');
                }
            } else {
                messageDisplay.style.display = 'none';
            }
        }


        // FunciÃ³n para cargar los botones de juego
        function loadGameOptions() {
            gameButtonsContainer.innerHTML = ''; 
            gameOptions.forEach(game => {
                const gameItemDiv = document.createElement('div');
                gameItemDiv.classList.add('game-item');
                gameItemDiv.dataset.gameName = game.name;

                const imgElement = document.createElement('img');
                imgElement.src = game.logoUrl || 'https://placehold.co/120x120/cccccc/000000?text=No Image'; 
                imgElement.alt = `Logo de ${game.name}`;
                imgElement.classList.add('game-logo');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = 'https://placehold.co/120x120/cccccc/000000?text=No Image'; 
                    console.error('Failed to load game logo image:', game.logoUrl);
                };

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('game-name-label');
                nameSpan.textContent = game.name;

                gameItemDiv.appendChild(imgElement);
                gameItemDiv.appendChild(nameSpan);

                gameItemDiv.addEventListener('click', () => {
                    selectedGame = game.name;
                    selectedAmount = null; // Limpiar artÃ­culo seleccionado al cambiar de juego
                    
                    Array.from(gameButtonsContainer.children).forEach(div => div.classList.remove('selected'));
                    gameItemDiv.classList.add('selected');

                    updateAmountSelection(); 
                    updatePriceSummary();
                    updateInputFields(); // Actualiza los campos de entrada al seleccionar un juego
                    messageDisplay.style.display = 'none';
                    transferWarningMessage.style.display = 'block';
                    updateSendOrderButtonState();

                    // Desplazamiento suave a la secciÃ³n de artÃ­culos
                    amountSelectionDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                gameButtonsContainer.appendChild(gameItemDiv);
            });
        }

        // FunciÃ³n para actualizar los botones de monto con imÃ¡genes y precio local
        function updateAmountSelection() {
            amountButtonsDiv.innerHTML = ''; 
            if (selectedGame) {
                amountSelectionDiv.style.display = 'block'; 
                const currentAmounts = gameOptions.find(g => g.name === selectedGame)?.amounts;
                const countryInfo = countryData.find(c => c.name === selectedCountry) || defaultCountryInfo; 

                if (currentAmounts && currentAmounts.length > 0) {
                    currentAmounts.forEach(amount => {
                        const itemDiv = document.createElement('div'); 
                        itemDiv.classList.add('amount-item'); // Ahora amount-item ya tiene los estilos base
                        // Guardar todos los datos del artÃ­culo en el dataset para fÃ¡cil recuperaciÃ³n
                        itemDiv.dataset.value = amount.value; 
                        itemDiv.dataset.label = amount.label; 
                        itemDiv.dataset.imageUrl = amount.imageUrl; 

                        const imgElement = document.createElement('img');
                        imgElement.src = amount.imageUrl;
                        imgElement.alt = amount.label;
                        imgElement.classList.add('item-image');
                        imgElement.width = 80;
                        imgElement.height = 80;
                        imgElement.loading = 'lazy'; 
                        
                        imgElement.onerror = function() {
                            this.onerror = null; 
                            this.src = 'https://placehold.co/80x80/cccccc/000000?text=No Image'; 
                            console.error('Failed to load item image:', amount.imageUrl);
                        };

                        const itemTextContainer = document.createElement('div'); 
                        itemTextContainer.classList.add('item-text-container');

                        const labelSpan = document.createElement('span');
                        labelSpan.classList.add('item-label');
                        labelSpan.textContent = amount.label;

                        // Verificar si estÃ¡ en promociÃ³n y agregar badge
                        const promoInfo = getPromotionInfo(selectedGame, amount.label);
                        if (promoInfo) {
                            itemDiv.classList.add('promo-item', promoInfo.animation);
                            const promoBadge = document.createElement('span');
                            promoBadge.classList.add('promo-badge');
                            promoBadge.textContent = promoInfo.badge;
                            itemDiv.appendChild(promoBadge);
                        }

                        itemTextContainer.appendChild(labelSpan);

                        // LÃ³gica condicional para mostrar el precio: USD o moneda local
                        if (selectedCountry === '') {
                            // Mostrar solo precio en USD si no hay paÃ­s seleccionado
                            const priceUsdSpan = document.createElement('span');
                            priceUsdSpan.classList.add('item-price-usd');
                            priceUsdSpan.textContent = `${amount.value.toFixed(2)} USD`; 
                            itemTextContainer.appendChild(priceUsdSpan);
                        } else {
                            // Mostrar precio en moneda local si hay paÃ­s seleccionado
                            const priceLocalSpan = document.createElement('span');
                            priceLocalSpan.classList.add('item-price-local');
                            const localPrice = amount.value * countryInfo.exchangeRate;
                            priceLocalSpan.textContent = `${formatNumber(localPrice)} ${countryInfo.symbol}`; 
                            itemTextContainer.appendChild(priceLocalSpan);
                        }
                        
                        itemDiv.appendChild(imgElement);
                        itemDiv.appendChild(itemTextContainer); 

                        itemDiv.addEventListener('click', (e) => {
                            // Prevenir que el click en el badge de promociÃ³n interfiera
                            e.stopPropagation();
                            
                            // Deseleccionar todos los demÃ¡s artÃ­culos
                            Array.from(amountButtonsDiv.children).forEach(div => div.classList.remove('selected'));
                            
                            // Seleccionar solo este artÃ­culo
                            itemDiv.classList.add('selected');
                            selectedAmount = amount; // Almacenar el objeto del artÃ­culo seleccionado

                            updatePriceSummary();
                            messageDisplay.style.display = 'none'; 
                            transferWarningMessage.style.display = 'block'; 
                            updateSendOrderButtonState();

                            // Desplazamiento suave a la secciÃ³n de informaciÃ³n del usuario
                            userInfoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        });

                        // Marcar como seleccionado si es el artÃ­culo actualmente seleccionado
                        if (selectedAmount && selectedAmount.value === amount.value && selectedAmount.label === amount.label) {
                            itemDiv.classList.add('selected');
                        }

                        amountButtonsDiv.appendChild(itemDiv);
                    });
                } else {
                    amountButtonsDiv.innerHTML = '<p style="color: #FF6347; font-weight: bold;">No hay artÃ­culos disponibles para este juego.</p>';
                }
            } else {
                amountSelectionDiv.style.display = 'none'; 
            }
        }

        // FunciÃ³n para cargar opciones de paÃ­s como botones
        function loadCountryOptions() {
            countrySelectContainer.innerHTML = ''; // Limpiar botones existentes
            countryData.forEach(country => {
                const countryItemDiv = document.createElement('div');
                countryItemDiv.classList.add('country-item');
                countryItemDiv.dataset.countryName = country.name;

                const imgElement = document.createElement('img');
                imgElement.src = country.imageUrl || `https://placehold.co/60x60/CCCCCC/000000?text=${country.code}`; // Usar cÃ³digo si no hay URL
                imgElement.alt = `Bandera de ${country.name}`;
                imgElement.classList.add('country-image');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = `https://placehold.co/60x60/CCCCCC/000000?text=${country.code}`; 
                    console.error('Failed to load country image:', country.imageUrl);
                };

                countryItemDiv.appendChild(imgElement);
                // No se aÃ±ade el nombre del paÃ­s debajo de la imagen segÃºn la solicitud

                countryItemDiv.addEventListener('click', () => {
                    selectedCountry = country.name;
                    // Deseleccionar todos los demÃ¡s paÃ­ses
                    Array.from(countrySelectContainer.children).forEach(div => div.classList.remove('selected'));
                    countryItemDiv.classList.add('selected');
                    
                    updatePriceSummary(); // Actualizar el resumen con la nueva moneda
                    if (selectedGame) { // Si ya hay un juego seleccionado, actualizar los precios de los artÃ­culos
                        updateAmountSelection(); 
                    }
                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();

                    // Desplazamiento suave a la secciÃ³n de juegos
                    gameSelectionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                countrySelectContainer.appendChild(countryItemDiv);
            });
            selectedCountry = ''; // Asegurarse de que no haya paÃ­s preseleccionado al cargar
        }

        // FunciÃ³n para cargar opciones de vendedor como botones
        function loadSellerOptions() {
            sellerSelectContainer.innerHTML = ''; // Limpiar botones existentes
            sellerData.forEach(seller => {
                const sellerItemDiv = document.createElement('div');
                sellerItemDiv.classList.add('seller-item');
                sellerItemDiv.dataset.sellerName = seller.name;

                const imgElement = document.createElement('img');
                imgElement.src = seller.imageUrl || 'https://placehold.co/60x60/CCCCCC/000000?text=V'; // Placeholder si no hay imagen
                imgElement.alt = `Foto de ${seller.name}`;
                imgElement.classList.add('seller-image');
                
                imgElement.onerror = function() {
                    this.onerror = null; 
                    this.src = 'https://placehold.co/60x60/CCCCCC/000000?text=V'; 
                    console.error('Failed to load seller image:', seller.imageUrl);
                };

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('seller-name-label');
                nameSpan.textContent = seller.name;

                if (seller.name === 'XJoseDharckX') {
                    nameSpan.classList.add('highlighted-seller');
                }

                sellerItemDiv.appendChild(imgElement);
                sellerItemDiv.appendChild(nameSpan);

                sellerItemDiv.addEventListener('click', () => {
                    selectedSeller = seller.name;
                    // Deseleccionar todos los demÃ¡s vendedores
                    Array.from(sellerSelectContainer.children).forEach(div => div.classList.remove('selected'));
                    sellerItemDiv.classList.add('selected');

                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();

                    // Desplazamiento suave al botÃ³n de enviar
                    sendWhatsAppOrderBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                sellerSelectContainer.appendChild(sellerItemDiv);
            });
            selectedSeller = ''; // Asegurarse de que no haya vendedor preseleccionado al cargar
        }

        // FunciÃ³n: Actualiza la visibilidad y requisitos de los campos de entrada
        function updateInputFields() {
            idNameInputs.style.display = 'none';
            idServerInputs.style.display = 'none';
            idOnlyInputs.style.display = 'none';
            codInputs.style.display = 'none';
            document.getElementById('mlNameInput').style.display = 'none'; 

            const allInputs = [
                userIdInput, userNameInput, userIdServerInput, serverInput, userNameMLInput,
                userIdOnlyInput, emailInput, passwordInput, linkageInput, exactAccountNameInput
            ];
            allInputs.forEach(input => {
                if (input) { 
                    input.value = '';
                    input.required = false;
                }
            });

            const currentGame = gameOptions.find(g => g.name === selectedGame);
            if (!currentGame) return;

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    idNameInputs.style.display = 'block';
                    userIdInput.required = true;
                    userNameInput.required = true;
                    break;
                case 'id_server':
                    idServerInputs.style.display = 'block';
                    userIdServerInput.required = true;
                    serverInput.required = true;
                    break;
                case 'id_server_name': 
                    idServerInputs.style.display = 'block';
                    userIdServerInput.required = true;
                    serverInput.required = true;
                    document.getElementById('mlNameInput').style.display = 'block'; 
                    userNameMLInput.required = true;
                    break;
                case 'id_only':
                    idOnlyInputs.style.display = 'block';
                    userIdOnlyInput.required = true;
                    break;
                case 'cod_full':
                    codInputs.style.display = 'block';
                    emailInput.required = true;
                    passwordInput.required = true;
                    linkageInput.required = true;
                    exactAccountNameInput.required = true;
                    break;
                default:
                    break;
            }
            updateSendOrderButtonState(); 
        }


        // Manejadores de input para validar y restablecer botones
        [userIdInput, userNameInput, userIdServerInput, serverInput, userNameMLInput, userIdOnlyInput,
         emailInput, passwordInput, linkageInput, exactAccountNameInput].forEach(input => {
            if (input) { 
                input.addEventListener('input', () => {
                    messageDisplay.style.display = 'none'; 
                    transferWarningMessage.style.display = 'block'; 
                    updateSendOrderButtonState();
                });
            }
        });



        // Manejador de cambio de vendedor (AHORA MANEJADO POR CLICK EN BOTONES)
        // Ya no es necesario sellerSelect.addEventListener('change', ...)
        
        // Manejador de cambio de paÃ­s (AHORA MANEJADO POR CLICK EN BOTONES)
        // Ya no es necesario countrySelect.addEventListener('change', ...)
        
        // FunciÃ³n para actualizar el resumen del precio y los mÃ©todos de pago
        function updatePriceSummary() {
            // selectedAmount ahora es un objeto o null
            let selectedAmountUSD = selectedAmount ? selectedAmount.value : 0;

            if (selectedAmountUSD > 0 && selectedCountry) {
                const countryInfo = countryData.find(country => country.name === selectedCountry); 
                
                if (!countryInfo) {
                    priceSummaryDiv.style.display = 'none'; 
                    paymentMethodsDisplayDiv.style.display = 'none'; 
                    selectedItemsPreview.innerHTML = ''; 
                    return;
                }

                totalPrice = selectedAmountUSD * countryInfo.exchangeRate;
                currencySymbol = countryInfo.symbol;
                
                totalPriceDisplay.textContent = formatNumber(totalPrice); 
                currencySymbolDisplay.textContent = currencySymbol;
                baseAmountDisplay.textContent = selectedAmountUSD.toFixed(2);
                priceSummaryDiv.style.display = 'block'; 

                // Mostrar miniatura del artÃ­culo seleccionado (singular)
                selectedItemsPreview.innerHTML = '';
                if (selectedAmount) {
                    const img = document.createElement('img');
                    img.src = selectedAmount.imageUrl;
                    img.alt = selectedAmount.label;
                    img.title = selectedAmount.label; 
                    img.classList.add('selected-item-thumbnail');
                    img.onerror = function() {
                        this.onerror = null; 
                        this.src = 'https://placehold.co/50x50/cccccc/000000?text=No Image'; 
                        console.error('Failed to load thumbnail image:', selectedAmount.imageUrl);
                    };
                    selectedItemsPreview.appendChild(img);
                }

                // Mostrar mÃ©todos de pago para el paÃ­s seleccionado
                paymentMethodsListDiv.innerHTML = '';
                if (countryInfo.paymentMethods && countryInfo.paymentMethods.length > 0) {
                    paymentMethodsDisplayDiv.style.display = 'block'; 
                    countryInfo.paymentMethods.forEach(method => {
                        const p = document.createElement('p');
                        p.innerHTML = `<span>${method.name}:</span> ${method.details}`;
                        paymentMethodsListDiv.appendChild(p);
                    });

                    sendWhatsAppOrderBtn.style.display = 'block';
                } else {
                    paymentMethodsDisplayDiv.style.display = 'none'; 

                    sendWhatsAppOrderBtn.style.display = 'none';
                }

            } else {
                priceSummaryDiv.style.display = 'none'; 
                paymentMethodsDisplayDiv.style.display = 'none'; 

                selectedItemsPreview.innerHTML = ''; 
            }
        }

        // FunciÃ³n para mostrar mensajes al usuario
        function showMessage(msg, type) {
            messageDisplay.textContent = msg;
            messageDisplay.style.display = 'block'; 
            messageDisplay.classList.remove('message-error', 'message-success', 'message-info'); 

            if (type === 'error') {
                messageDisplay.classList.add('message-error');
            } else if (type === 'success') {
                messageDisplay.classList.add('message-success');
            } else if (type === 'info') {
                messageDisplay.classList.add('message-info');
            }
        }

        // FunciÃ³n para mostrar el modal de advertencia de WhatsApp
        function showWhatsAppWarningModal() {
            whatsappWarningModal.style.display = 'flex'; 
            messageDisplay.style.display = 'none'; 
        }

        // FunciÃ³n para ocultar el modal de advertencia de WhatsApp
        function hideWhatsAppWarningModal() {
            whatsappWarningModal.style.display = 'none'; 
        }




        // Manejador del envÃ­o del formulario (modificado para WhatsApp) - ahora activado por sendWhatsAppOrderBtn
        topupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (sendWhatsAppOrderBtn.disabled) {
                return;
            }
            
            // Realizar validaciones finales antes de mostrar el modal
            if (!selectedCountry) { showMessage('Por favor, selecciona tu paÃ­s para continuar.', 'error'); return; }
            const currentGame = gameOptions.find(g => g.name === selectedGame);
            if (!currentGame) { showMessage('Por favor, selecciona un juego.', 'error'); return; }
            if (selectedAmount === null) { showMessage('Por favor, selecciona un artÃ­culo/monto.', 'error'); return; }

            let isValid = true;
            let errorMessage = '';

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    if (!userIdInput.value.trim() || !userNameInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa tu ID y Nombre de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El ID de Jugador solo debe contener nÃºmeros.';
                    }
                    break;
                case 'id_server':
                    if (!userIdServerInput.value.trim() || !serverInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa el UID y el Servidor.';
                    } else if (!/^[0-9]*$/.test(userIdServerInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El UID solo debe contener nÃºmeros.';
                    }
                    break;
                case 'id_server_name': 
                    if (!userIdServerInput.value.trim() || !serverInput.value.trim() || !userNameMLInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa la ID, el Servidor y el Nombre de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdServerInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'La ID solo debe contener nÃºmeros.';
                    }
                    break;
                case 'id_only':
                    if (!userIdOnlyInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, ingresa tu ID de Jugador.';
                    } else if (!/^[0-9]*$/.test(userIdOnlyInput.value.trim())) {
                        isValid = false;
                        errorMessage = 'El ID de Jugador solo debe contener nÃºmeros.';
                    }
                    break;
                case 'cod_full':
                    if (!emailInput.value.trim() || !passwordInput.value.trim() || !linkageInput.value.trim() || !exactAccountNameInput.value.trim()) {
                        isValid = false;
                        errorMessage = 'Por favor, completa todos los campos de Call of Duty Mobile.';
                    } else if (!emailInput.value.includes('@')) { 
                        isValid = false;
                        errorMessage = 'Por favor, ingresa un correo electrÃ³nico vÃ¡lido.';
                    }
                    break;
                default:
                    isValid = false;
                    errorMessage = 'Tipo de juego no reconocido o campos incompletos.';
                    break;
            }

            if (!isValid) {
                showMessage(errorMessage, 'error');
                return;
            }

            if (!selectedSeller) { showMessage('Por favor, selecciona un vendedor.', 'error'); return; }
            
            showWhatsAppWarningModal();
        });

        // Oyente de eventos para el botÃ³n "Confirmar y Enviar" en el modal (este es el que realmente envÃ­a a WhatsApp)
        confirmWhatsAppBtn.addEventListener('click', async () => {
            hideWhatsAppWarningModal(); 
            loadingOverlay.style.display = 'flex'; 

            gameHidden.value = selectedGame;
            amountUSDHidden.value = selectedAmount ? selectedAmount.value : ''; 
            totalPriceHidden.value = totalPrice;
            currencySymbolHidden.value = currencySymbol;

            // Generar informaciÃ³n del artÃ­culo seleccionado para el mensaje de WhatsApp
            const selectedItemForWhatsapp = selectedAmount ? 
                `- ${selectedAmount.label} (${selectedAmount.value.toFixed(2)} USD / ${formatNumber(selectedAmount.value * (countryData.find(c => c.name === selectedCountry) || defaultCountryInfo).exchangeRate)} ${(countryData.find(c => c.name === selectedCountry) || defaultCountryInfo).symbol})` : 
                'No se seleccionÃ³ ningÃºn artÃ­culo.';

            const sellerInfo = sellerData.find(seller => seller.name === selectedSeller);
            const whatsappRecipientNumber = sellerInfo ? sellerInfo.phoneNumber : DEFAULT_WHATSAPP_NUMBER; 
            
            let playerInfo = '';
            const currentGame = gameOptions.find(g => g.name === selectedGame);

            if (currentGame) {
                switch (currentGame.inputRequirement) {
                    case 'id_name':
                        playerInfo = `ðŸ†” *ID del Jugador*: ${userIdInput.value.trim()}\nðŸ‘¤ *Nombre del Jugador*: ${userNameInput.value.trim()}`;
                        break;
                    case 'id_server':
                        playerInfo = `ðŸ†” *UID*: ${userIdServerInput.value.trim()}\nðŸŒ *Servidor*: ${serverInput.value.trim()}`;
                        break;
                    case 'id_server_name': 
                        playerInfo = `ðŸ†” *ID del Jugador*: ${userIdServerInput.value.trim()}\nðŸŒ *Servidor*: ${serverInput.value.trim()}\nðŸ‘¤ *Nombre del Jugador*: ${userNameMLInput.value.trim()}`;
                        break;
                    case 'id_only':
                        playerInfo = `ðŸ†” *ID del Jugador*: ${userIdOnlyInput.value.trim()}`;
                        break;
                    case 'cod_full':
                        playerInfo = `ðŸ“§ *Correo*: ${emailInput.value.trim()}\nðŸ”‘ *ContraseÃ±a*: ${passwordInput.value.trim()}\nðŸ”— *VinculaciÃ³n*: ${linkageInput.value.trim()}\nðŸ“ *Nombre Exacto*: ${exactAccountNameInput.value.trim()}`;
                        break;
                    default:
                        playerInfo = 'InformaciÃ³n del jugador no disponible.';
                        break;
                }
            }

            const whatsappMessageContent =
                `ðŸ“ *Pedido de Recarga - DHARCK STORE*:\n\n` +
                `${playerInfo}\n` + 
                `ðŸ’¼ *Vendedor*: ${selectedSeller}\n` + 
                `ðŸŽ® *Juego*: ${selectedGame}\n` +
                `ðŸ›’ *ArtÃ­culo Seleccionado*:\n${selectedItemForWhatsapp}\n` + 
                `ðŸ’¸ *Total a Pagar*: ${formatNumber(totalPrice)} ${currencySymbol}\n` + 
                `  _(Base: ${(selectedAmount ? selectedAmount.value : 0).toFixed(2)} USD + comisiÃ³n)_\n` + 
                `ðŸŒŽ *PaÃ­s*: ${selectedCountry}\n\n` +
                `âš ï¸ *Â¡Importante!*: Por favor, envÃ­ame el comprobante de pago.`;

            // -----------------------------------------------------
            // Crear orden pendiente en el backend
            // -----------------------------------------------------
            const countryInfo = countryData.find(c => c.name === selectedCountry);
            
            // Mapear correctamente los datos segÃºn el tipo de juego
            let playerId = '';
            let playerName = '';
            let playerEmail = '';
            let additionalInfo = '';

            switch (currentGame.inputRequirement) {
                case 'id_name':
                    playerId = userIdInput.value.trim();
                    playerName = userNameInput.value.trim();
                    break;
                case 'id_server':
                    playerId = userIdServerInput.value.trim();
                    additionalInfo = serverInput.value.trim();
                    break;
                case 'id_server_name':
                    playerId = userIdServerInput.value.trim();
                    playerName = userNameMLInput.value.trim();
                    additionalInfo = serverInput.value.trim();
                    break;
                case 'id_only':
                    playerId = userIdOnlyInput.value.trim();
                    break;
                case 'cod_full':
                    playerEmail = emailInput.value.trim();
                    playerName = exactAccountNameInput.value.trim();
                    additionalInfo = `ContraseÃ±a: ${passwordInput.value.trim()}, VinculaciÃ³n: ${linkageInput.value.trim()}`;
                    break;
            }

            const orderData = {
                sellerName: selectedSeller,
                gameName: selectedGame,
                itemLabel: selectedAmount ? selectedAmount.label : 'N/A',
                amountUSD: selectedAmount ? selectedAmount.value : 0,
                totalPrice: totalPrice,
                currencySymbol: countryInfo ? countryInfo.symbol : currencySymbol,
                playerId: playerId,
                playerName: playerName,
                playerEmail: playerEmail,
                additionalInfo: additionalInfo,
                countryName: selectedCountry
            };

            try {
                const BASE_API_URL = window.location.origin + '/api';
                const response = await fetch(`${BASE_API_URL}/pending-orders`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error al crear la orden pendiente:', errorText);
                    showMessage('Error al registrar la orden en el servidor. Por favor, avisa al soporte.', 'error');
                } else {
                    showMessage('Orden registrada exitosamente y preparando WhatsApp...', 'success');
                }
            } catch (error) {
                console.error('Error de red al intentar crear la orden:', error);
                showMessage('Error de conexiÃ³n al servidor al intentar registrar la orden.', 'error');
            }
            // -----------------------------------------------------
            // FIN: CreaciÃ³n de orden pendiente
            // -----------------------------------------------------

            // Abrir WhatsApp en una nueva pestaÃ±a/ventana
            window.open(`https://wa.me/${whatsappRecipientNumber}?text=${encodeURIComponent(whatsappMessageContent)}`, '_blank');

            // DespuÃ©s de un breve retraso, ocultar la animaciÃ³n de carga y mostrar el mensaje de Ã©xito
            setTimeout(() => {
                loadingOverlay.style.display = 'none'; 
                showMessage('Â¡Pedido registrado exitosamente! SerÃ¡ procesado por nuestro equipo y entregado en 5-15 minutos.', 'success'); 

                // Opcional: Limpiar el formulario despuÃ©s de un envÃ­o exitoso
                topupForm.reset();
                selectedGame = '';
                selectedAmount = null; 
                selectedCountry = ''; 
                // No necesitamos countrySelect.value = ''; ni sellerSelect.value = ''; porque ya no son <select>
                selectedSeller = ''; 
                priceSummaryDiv.style.display = 'none'; 
                paymentMethodsDisplayDiv.style.display = 'none'; 
                amountSelectionDiv.style.display = 'none'; 
                amountButtonsDiv.innerHTML = '';
                selectedItemsPreview.innerHTML = ''; 
                
                // Quitar la clase 'selected' de todos los botones de juego, paÃ­s, vendedor y ocultar campos de usuario
                Array.from(gameButtonsContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(countrySelectContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(sellerSelectContainer.children).forEach(div => div.classList.remove('selected'));
                Array.from(amountButtonsDiv.children).forEach(div => div.classList.remove('selected'));
                updateInputFields(); 

                transferWarningMessage.style.display = 'block'; 
                updateSendOrderButtonState(); 
            }, 2000); 
        });

        // Oyente de eventos para el botÃ³n "Cancelar" en el modal
        cancelWhatsAppBtn.addEventListener('click', () => {
            hideWhatsAppWarningModal(); 
            showMessage('EnvÃ­o de pedido cancelado.', 'info');
        });

       // FunciÃ³n para cargar configuraciÃ³n de artÃ­culos desde servidor o localStorage
        async function loadArticlesConfig() {
            try {
                // Agregar timestamp para evitar cachÃ© del navegador
                const timestamp = new Date().getTime();
                const BASE_API_URL = window.location.origin;
                const response = await fetch(`${BASE_API_URL}/api/articles-config?t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const serverConfig = await response.json();
                    
                    if (serverConfig && Object.keys(serverConfig).length > 0) {
                        // Convertir configuraciÃ³n del servidor a formato gameOptions
                        gameOptions = Object.keys(serverConfig).map(gameName => {
                            const gameConfig = serverConfig[gameName];
                            const activeArticles = gameConfig.articles.filter(article => article.active);
                            
                            return {
                                name: gameName,
                                logoUrl: gameConfig.logoUrl,
                                inputRequirement: gameConfig.inputRequirement,
                                amounts: activeArticles.map(article => ({
                                    value: article.value,
                                    label: article.label,
                                    imageUrl: article.imageUrl || '/image/prize-2.png',
                                    promotion: article.promotion
                                }))
                            };
                        }).filter(game => game.amounts.length > 0); // Solo juegos con artÃ­culos activos
                        
                        // Actualizar localStorage con la nueva configuraciÃ³n
                        localStorage.setItem('gameArticlesConfig', JSON.stringify(serverConfig));
                        console.log('ConfiguraciÃ³n cargada desde servidor:', gameOptions.length, 'juegos activos');
                        
                        // IMPORTANTE: Re-renderizar la interfaz despuÃ©s de cargar
                        if (typeof loadGameOptions === 'function') {
                            loadGameOptions();
                        }
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error cargando desde servidor:', error);
            }
            
            // Fallback a localStorage
            const savedConfig = localStorage.getItem('gameArticlesConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    gameOptions = Object.keys(config).map(gameName => {
                        const gameConfig = config[gameName];
                        const activeArticles = gameConfig.articles.filter(article => article.active);
                        
                        return {
                            name: gameName,
                            logoUrl: gameConfig.logoUrl,
                            inputRequirement: gameConfig.inputRequirement,
                            amounts: activeArticles.map(article => ({
                                value: article.value,
                                label: article.label,
                                imageUrl: article.imageUrl || '/image/prize-2.png',
                                promotion: article.promotion
                            }))
                        };
                    }).filter(game => game.amounts.length > 0);
                    
                    console.log('ConfiguraciÃ³n cargada desde localStorage:', gameOptions.length, 'juegos activos');
                    
                    // Re-renderizar la interfaz
                    if (typeof loadGameOptions === 'function') {
                        loadGameOptions();
                    }
                    
                    return true;
                } catch (parseError) {
                    console.error('Error parseando localStorage:', parseError);
                    gameOptions = [];
                }
            }
            
            return false;
        }

        // FunciÃ³n para refrescar configuraciÃ³n (llamar desde consola para debug)
        window.refreshArticlesConfig = async function() {
            console.log('Refrescando configuraciÃ³n de artÃ­culos...');
            await loadArticlesConfig();
            console.log('ConfiguraciÃ³n actualizada. Juegos disponibles:', gameOptions.length);
        };

        // FunciÃ³n de debug para verificar configuraciÃ³n
        window.debugArticles = function() {
            console.log('=== DEBUG CONFIGURACIÃ“N DE ARTÃCULOS ===');
            console.log('gameOptions:', gameOptions);
            console.log('localStorage gameArticlesConfig:', localStorage.getItem('gameArticlesConfig'));
            
            // Verificar cada juego
            gameOptions.forEach(game => {
                console.log(`${game.name}: ${game.amounts.length} artÃ­culos activos`);
                game.amounts.forEach(article => {
                    console.log(`  - ${article.label}: $${article.value}`);
                });
            });
        };

        // FunciÃ³n para limpiar cachÃ© y recargar
        window.clearCacheAndReload = function() {
            localStorage.removeItem('gameArticlesConfig');
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            window.location.reload(true);
        };

        console.log('Funciones de debug disponibles:');
        console.log('- window.debugArticles() - Ver configuraciÃ³n actual');
        console.log('- window.refreshArticlesConfig() - Refrescar desde servidor');
        console.log('- window.clearCacheAndReload() - Limpiar cachÃ© y recargar');

        // Auto-refresh cada 2 minutos para mantener sincronizado
        setInterval(async () => {
            console.log('Auto-refresh de configuraciÃ³n de artÃ­culos...');
            await loadArticlesConfig();
        }, 120000); // 2 minutos

        // Inicializar la pÃ¡gina cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando aplicaciÃ³n...');
            
            // Cargar configuraciÃ³n de artÃ­culos PRIMERO
            const configLoaded = await loadArticlesConfig();
            console.log('ConfiguraciÃ³n de artÃ­culos cargada:', configLoaded);
            
            // Luego cargar el resto
            await loadExchangeRates();
            loadCountryOptions();
            loadGameOptions(); // Ahora cargarÃ¡ los juegos dinÃ¡micos actualizados
            loadSellerOptions();
            updateSendOrderButtonState();
            updateInputFields();
            
            // Intervalo para tasas de cambio
            setInterval(loadExchangeRates, 5 * 60 * 1000);
            
            console.log('AplicaciÃ³n inicializada completamente');
        });

    </script>
    
    <!-- Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registrado:', registration);
                
                // Verificar actualizaciones cada 30 segundos
                setInterval(() => {
                    registration.update();
                }, 30000);
                
                // Escuchar actualizaciones del service worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Hay una nueva versiÃ³n disponible
                            if (confirm('Nueva versiÃ³n disponible. Â¿Recargar pÃ¡gina?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.log('Error registrando Service Worker:', error);
            });
    }
    </script>
</body>
</html>
